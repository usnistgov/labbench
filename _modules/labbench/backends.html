
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>labbench.backends &#8212; labbench v0.20</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
<header class="nist-header">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>NIST Pages Template</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="labbench v0.20">
  <link rel="canonical" href="../../">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Google Analytics -->
  <!--<script type="text/javascript" id="_fed_an_js_tag" src="http://www.nist.gov/js/federated-analytics.all.min.js?agency=NIST&subagency=mml&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script> -->
  <!-- DAP Analytics -->
  <script type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&subagefncy=NIST&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../..//_static/NISTStyle.css">
  <link rel="stylesheet" href="../..//_static/NISTPages.css">

  <h1>
    <a class="nist-logo" target="_blank" href="http://www.nist.gov/" title="Go to nist.gov">National Institute of Standards and Technology</a>
  </h1>
  <div class="nist-links">
    <a class="nist-links-button" target="_blank" href="http://www.nist.gov">NIST Website</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="http://www.nist.gov/public_affairs/nandyou.cfm">About NIST</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="https://github.com/usnistgov">usnistgov on GitHub</a>
  </div>
  
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</header>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench v0.20</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for labbench.backends</h1><div class="highlight"><pre>
<span></span><span class="c1"># This software was developed by employees of the National Institute of</span>
<span class="c1"># Standards and Technology (NIST), an agency of the Federal Government.</span>
<span class="c1"># Pursuant to title 17 United States Code Section 105, works of NIST employees</span>
<span class="c1"># are not subject to copyright protection in the United States and are</span>
<span class="c1"># considered to be in the public domain. Permission to freely use, copy,</span>
<span class="c1"># modify, and distribute this software and its documentation without fee is</span>
<span class="c1"># hereby granted, provided that this notice and disclaimer of warranty appears</span>
<span class="c1"># in all copies.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &#39;AS IS&#39; WITHOUT ANY WARRANTY OF ANY KIND, EITHER</span>
<span class="c1"># EXPRESSED, IMPLIED, OR STATUTORY, INCLUDING, BUT NOT LIMITED TO, ANY WARRANTY</span>
<span class="c1"># THAT THE SOFTWARE WILL CONFORM TO SPECIFICATIONS, ANY IMPLIED WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND FREEDOM FROM</span>
<span class="c1"># INFRINGEMENT, AND ANY WARRANTY THAT THE DOCUMENTATION WILL CONFORM TO THE</span>
<span class="c1"># SOFTWARE, OR ANY WARRANTY THAT THE SOFTWARE WILL BE ERROR FREE. IN NO EVENT</span>
<span class="c1"># SHALL NIST BE LIABLE FOR ANY DAMAGES, INCLUDING, BUT NOT LIMITED TO, DIRECT,</span>
<span class="c1"># INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES, ARISING OUT OF, RESULTING FROM,</span>
<span class="c1"># OR IN ANY WAY CONNECTED WITH THIS SOFTWARE, WHETHER OR NOT BASED UPON</span>
<span class="c1"># WARRANTY, CONTRACT, TORT, OR OTHERWISE, WHETHER OR NOT INJURY WAS SUSTAINED</span>
<span class="c1"># BY PERSONS OR PROPERTY OR OTHERWISE, AND WHETHER OR NOT LOSS WAS SUSTAINED</span>
<span class="c1"># FROM, OR AROSE OUT OF THE RESULTS OF, OR USE OF, THE SOFTWARE OR SERVICES</span>
<span class="c1"># PROVIDED HEREUNDER. Distributions of NIST software should also include</span>
<span class="c1"># copyright and licensing statements of any third-party software that are</span>
<span class="c1"># legally bundled with the code in compliance with the conditions of those</span>
<span class="c1"># licenses.</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="k">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Event</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CommandLineWrapper&#39;</span><span class="p">,</span>
           <span class="s1">&#39;DotNetDevice&#39;</span><span class="p">,</span>
           <span class="s1">&#39;EmulatedVISADevice&#39;</span><span class="p">,</span>
           <span class="s1">&#39;LabviewSocketInterface&#39;</span><span class="p">,</span>
           <span class="s1">&#39;SerialDevice&#39;</span><span class="p">,</span>
           <span class="s1">&#39;SerialLoggingDevice&#39;</span><span class="p">,</span>
           <span class="s1">&#39;TelnetDevice&#39;</span><span class="p">,</span>
           <span class="s1">&#39;VISADevice&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Win32ComDevice&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="CommandLineWrapper"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper">[docs]</a><span class="k">class</span> <span class="nc">CommandLineWrapper</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Virtual device representing for interacting with a command line\</span>
<span class="sd">        executable. It supports threaded data logging through standard</span>
<span class="sd">        input, standard output, and standard error pipes.</span>

<span class="sd">        On connection, the `backend` attribute is None. On a</span>
<span class="sd">        call to execute(), `backend` becomes is a subprocess instance. When</span>
<span class="sd">        EOF is reached on the executable&#39;s stdout, the backend is assumed</span>
<span class="sd">        terminated and is reset to None.</span>

<span class="sd">        When `execute` is called, the program runs in a subprocess.</span>
<span class="sd">        The output piped to the command line standard output is queued in a</span>
<span class="sd">        background thread. Call read_stdout() to retreive (and clear) this</span>
<span class="sd">        queued stdout.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CommandLineWrapper.settings"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">binary_path</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span>
            <span class="n">core</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to the file to run&#39;</span><span class="p">)</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Timeout (sec) after disconnect is called before killing the process&#39;</span><span class="p">)</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
            <span class="p">[],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;list of command line arguments to pass into the executable&#39;</span><span class="p">)</span>
        <span class="n">arguments_min</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s1">&#39;minimum number of extra command line arguments to pass to the executable&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__imports__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">sp</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">subprocess32</span> <span class="k">as</span> <span class="nn">sp</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>

<div class="viewcode-block" id="CommandLineWrapper.connect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The :meth:`connect` method exists to comply with the</span>
<span class="sd">            :class:`Device` object protocol. Call the</span>
<span class="sd">            :meth:`execute` method when connected to</span>
<span class="sd">            execute the binary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">check_state_change</span><span class="p">(</span><span class="n">change</span><span class="o">=</span><span class="p">{}):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;cannot change command line state traits during execution&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;executable does not exist at resource=r&quot;</span><span class="si">{self.settings.binary_path}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

        <span class="c1"># Monitor state changes</span>
        <span class="n">states</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>\
            <span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">CommandLineWrapper</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">check_state_change</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">states</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">no_state_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Use this context manager to disable automatic use of state traits</span>
<span class="sd">            in generating argument strings.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="p">[</span><span class="s1">&#39;use_state_arguments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="p">[</span><span class="s1">&#39;use_state_arguments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">respawn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Use this context manager to respawning background execution.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="p">[</span><span class="s1">&#39;respawn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="p">[</span><span class="s1">&#39;respawn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">exception_on_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Use this context manager to raise exceptions if a process outputs</span>
<span class="sd">            to standard error during background execution.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="p">[</span><span class="s1">&#39;exception_on_stderr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="p">[</span><span class="s1">&#39;exception_on_stderr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="CommandLineWrapper.foreground"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.foreground">[docs]</a>    <span class="k">def</span> <span class="nf">foreground</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Blocking execution of the binary at the file location</span>
<span class="sd">            `self.settings.binary_path`.</span>

<span class="sd">            Normally, the command line arguments are determined by</span>
<span class="sd">            * appending extra_arguments to the global arguments in self.settings.arguments, and</span>
<span class="sd">            * appending pairs of [key,value] from the `flags` dictionary to the</span>
<span class="sd">              global flags defined with command flags in local state traits in</span>
<span class="sd">              `self.settings`</span>

<span class="sd">            Use the self.no_state_arguments context manager to skip these</span>
<span class="sd">            global arguments like this::</span>

<span class="sd">                with self.no_state_arguments:</span>
<span class="sd">                    self.foreground(...)</span>

<span class="sd">            :returns: the return code of the process after its completion</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cmdl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_commandline</span><span class="p">(</span><span class="o">*</span><span class="n">extra_arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">cmdl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">cmdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;foreground execute &#39;</span> <span class="o">+</span>
                          <span class="nb">repr</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">path</span><span class="p">,)</span> <span class="o">+</span> <span class="n">cmdl</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmdl</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">stdout</span>

        <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;-&gt; {ret.decode()}&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-&gt; (</span><span class="si">{count}</span><span class="s2"> lines)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>
<span class="c1">#        if ret != self.settings.return_code_ok:</span>
<span class="c1">#            raise ValueError(&#39;process returned error code {}&#39;\</span>
<span class="c1">#                             .format(ret))</span>

<div class="viewcode-block" id="CommandLineWrapper.background"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.background">[docs]</a>    <span class="k">def</span> <span class="nf">background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Run the executable in the background (returning immediately while</span>
<span class="sd">            the executable continues running).</span>

<span class="sd">            Once the background process is running,</span>

<span class="sd">            * Retreive standard output from the executable with self.read_stdout</span>

<span class="sd">            * Write to standard input self.write_stdin</span>

<span class="sd">            * Kill the process with self.kill</span>

<span class="sd">            * Check whether the process is running with self.running</span>

<span class="sd">            Normally, the command line arguments are determined by</span>

<span class="sd">            * appending extra_arguments to the global arguments in self.settings.arguments, and</span>

<span class="sd">            * appending pairs of [key,value] from the `flags` dictionary to the</span>
<span class="sd">              global flags defined with command flags in local state traits in</span>
<span class="sd">              `self.settings`</span>

<span class="sd">            Use the self.no_state_arguments context manager to skip these</span>
<span class="sd">            global arguments like this::</span>

<span class="sd">                with self.no_state_arguments:</span>
<span class="sd">                    self.background(...)</span>

<span class="sd">            :returns: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">stdout_to_queue</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmdl</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; Thread worker to funnel stdout into a queue</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">def</span> <span class="nf">readline</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">pid</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_queue</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Respawn (or don&#39;t)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="s1">&#39;respawn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kill</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;respawning&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kill_proc_tree</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                <span class="n">spawn</span><span class="p">(</span><span class="n">cmdl</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;stdout closed; execution done&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">stderr_to_exception</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmdl</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; Thread worker to raise exceptions on standard error output</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;stderr {repr(line)}&#39;</span><span class="p">)</span>
<span class="c1">#                    raise Exception(line)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">def</span> <span class="nf">spawn</span><span class="p">(</span><span class="n">cmdl</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Execute the binary in the background (nonblocking),</span>
<span class="sd">                while funneling its standard output to a queue in a thread.</span>

<span class="sd">                :param cmd: iterable containing the binary path, then</span>
<span class="sd">                            each argument to be passed to the binary.</span>

<span class="sd">                :returns: None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;already running&#39;</span><span class="p">)</span>

            <span class="n">si</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">STARTUPINFO</span><span class="p">()</span>
            <span class="n">si</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">|=</span> <span class="n">sp</span><span class="o">.</span><span class="n">STARTF_USESHOWWINDOW</span>

            <span class="n">proc</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cmdl</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">startupinfo</span><span class="o">=</span><span class="n">si</span><span class="p">,</span>
                            <span class="n">bufsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">creationflags</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span><span class="p">,</span>
                            <span class="n">stderr</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">proc</span>
            <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stdout_to_queue</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cmdl</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exception_on_stderr&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">stderr_to_exception</span><span class="p">(</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">cmdl</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Generate the commandline and spawn</span>
        <span class="n">cmdl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_commandline</span><span class="p">(</span><span class="o">*</span><span class="n">extra_arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">cmdl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">cmdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">&quot;background execute: {repr(&#39; &#39;.join((path,) + cmdl[1:]))}&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__kill</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__make_commandline</span><span class="p">(</span><span class="o">*</span><span class="n">extra_arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__make_commandline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">flags</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Form a list of commandline argument strings for foreground</span>
<span class="sd">            or background calls.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;command line flag keys and values must be strings&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;use_state_arguments&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">all_flags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">command</span><span class="p">])</span>

            <span class="c1"># Check for invalid flags</span>
            <span class="n">bad_flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">all_flags</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_flags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;commandline keyword arguments {repr(tuple(bad_flags))} not found in {repr(self)}.settings&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">arguments</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_arguments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_arguments</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">arguments_min</span>\
               <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">arguments_min</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="n">f</span><span class="s1">&#39;{repr(self)} given {repr(args)} arguments but needs at least </span><span class="si">{self.settings.arguments_min}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Set flags according to the arguments</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_arguments</span><span class="p">)</span>
            <span class="c1"># Set flags according to the arguments</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;command line values and flags must be strings&#39;</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">binary_path</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Update state traits with the flags</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__contexts</span><span class="p">[</span><span class="s1">&#39;use_state_arguments&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">command</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Bool</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">command</span><span class="p">,)</span>
                    <span class="k">elif</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cmd</span>

<div class="viewcode-block" id="CommandLineWrapper.read_stdout"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.read_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">read_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait_for</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return string output queued from stdout for a process running</span>
<span class="sd">            in the background. This clears the queue.</span>

<span class="sd">            Returns an empty string if the command line program has not been</span>
<span class="sd">            executed or is empty. Running the command line multiple times overwrites the queue.</span>

<span class="sd">            :returns: stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_queue</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdout_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">wait_for</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">line</span>

                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">line</span>

                <span class="k">if</span> <span class="n">wait_for</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">==</span> <span class="n">wait_for</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CommandLineWrapper.write_stdin"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.write_stdin">[docs]</a>    <span class="k">def</span> <span class="nf">write_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write characters to stdin if a background process is running. Raises</span>
<span class="sd">            Exception if no background process is running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">core</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;process not running, could not write no stdin&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CommandLineWrapper.kill"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If a process is running in the background, kill it. Sends a logger</span>
<span class="sd">            warning if no process is running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__kill</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kill_proc_tree</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;tried kill(), but no process is running&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CommandLineWrapper.running"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.running">[docs]</a>    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return whether the executable is currently running</span>

<span class="sd">            :returns: True if running, otherwise False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Cache the current running one for a second in case the backend</span>
        <span class="c1"># &quot;disconnects&quot;</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span> \
            <span class="ow">and</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="ow">and</span> <span class="n">backend</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CommandLineWrapper.clear"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear queued standard output, discarding any contents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">()</span></div>

<div class="viewcode-block" id="CommandLineWrapper.disconnect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandLineWrapper.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_kill_proc_tree</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">including_parent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Kill the process by pid, and any spawned child processes.</span>
<span class="sd">            What a dark metaphor.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

            <span class="c1"># Ever notice that this metaphor is very dark?</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Get the parent first to prevent respawning</span>
            <span class="k">if</span> <span class="n">including_parent</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="n">CommandLineWrapper</span><span class="o">.</span><span class="n">_kill_proc_tree</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="DotNetDevice"><a class="viewcode-back" href="../../labbench.html#labbench.backends.DotNetDevice">[docs]</a><span class="k">class</span> <span class="nc">DotNetDevice</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This Device backend represents a wrapper around a .NET library. It is implemented</span>
<span class="sd">        with pythonnet, and handlesimports.</span>

<span class="sd">        In order to implement a DotNetDevice subclass:</span>

<span class="sd">        * define the attribute `library = &lt;mypythonmodule.wheredllbinariesare&gt;`, the python module with copies of the .NET DLLs are</span>

<span class="sd">        * define the attribute `dll_name = &quot;mydllname.dll&quot;`, the name of the DLL binary in the python module above</span>

<span class="sd">        When a DotNetDevice is instantiated, it tries to load the dll according to the above specifications.</span>

<span class="sd">        Other attributes of DotNetDevice use the following conventions</span>

<span class="sd">        * `backend` may be set by a subclass `connect` method (otherwise it is left as None)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">library</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Must be a module</span>
    <span class="n">dll_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dlls</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__imports__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; DotNetDevice loads the DLL; importing in the</span>
<span class="sd">            class definition tries to load a lot of DLLs</span>
<span class="sd">            on import</span>
<span class="sd">            of ssmdevices, which would 1) break platforms</span>
<span class="sd">            that do not support the DLL, and 2) waste</span>
<span class="sd">            memory, and 3)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s1">&#39;__dll__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dll&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__dll__</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dll_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Need file name of a dll binary&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;Need the python module that shares the library path&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">clr</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;No module named clr&#39;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;could not import pythonnet support via clr module; no support for .NET drivers&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>

        <span class="kn">import</span> <span class="nn">os</span>
        <span class="n">clr</span><span class="o">.</span><span class="n">setPreload</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># CPython and .NET libraries: Are they friends?</span>
        <span class="n">clr</span><span class="o">.</span><span class="n">AddReference</span><span class="p">(</span><span class="s1">&#39;System.Reflection&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">System.Reflection</span> <span class="k">import</span> <span class="n">Assembly</span>
        <span class="kn">import</span> <span class="nn">System</span>

<span class="c1">#        if libname is None:</span>
        <span class="n">libname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dll_name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="s1">&#39;__loader__&#39;</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; If the python module is packaged as a .egg file,</span>
<span class="sd">                then use some introspection and the module&#39;s</span>
<span class="sd">                __loader__ to load the contents of the dll</span>
<span class="sd">            &quot;&quot;&quot;</span>
<span class="c1">#            relpath = module.__name__.replace(&#39;.&#39;, os.path.sep)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dll_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dll_name</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">__loader__</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dll_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dll_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Array</span><span class="p">[</span><span class="n">System</span><span class="o">.</span><span class="n">Byte</span><span class="p">](</span><span class="n">contents</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dlls</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dll_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Assembly</span><span class="o">.</span><span class="n">Load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dll</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">libname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__dll__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dll</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># Race condition =/</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="DotNetDevice.connect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.DotNetDevice.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="LabviewSocketInterface"><a class="viewcode-back" href="../../labbench.html#labbench.backends.LabviewSocketInterface">[docs]</a><span class="k">class</span> <span class="nc">LabviewSocketInterface</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Implement the basic sockets-based control interface for labview.</span>
<span class="sd">        This implementation uses a transmit and receive socket.</span>

<span class="sd">        State sets are implemented by simple &#39; command value&#39; strings</span>
<span class="sd">        and implemented with the &#39;command&#39; keyword (like VISA strings).</span>
<span class="sd">        Subclasses can therefore implement support for commands in</span>
<span class="sd">        specific labview VI the same was as in VISA commands by</span>
<span class="sd">        assigning the commands implemented in the corresponding labview VI.</span>

<span class="sd">        The `resource` argument (which can also be set as `settings.resource`)</span>
<span class="sd">        is the ip address of the host where the labview script</span>
<span class="sd">        is running. Use the tx_port and rx_port attributes to set the</span>
<span class="sd">        TCP/IP ports where communication is to take place.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LabviewSocketInterface.state"><a class="viewcode-back" href="../../labbench.html#labbench.backends.LabviewSocketInterface.state">[docs]</a>    <span class="k">class</span> <span class="nc">state</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="LabviewSocketInterface.settings"><a class="viewcode-back" href="../../labbench.html#labbench.backends.LabviewSocketInterface.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;IP address where the LabView VI listens for a socket&#39;</span><span class="p">)</span>
        <span class="n">tx_port</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="mi">61551</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;TX port to send to the LabView VI&#39;</span><span class="p">)</span>
        <span class="n">rx_port</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="mi">61552</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;TX port to send to the LabView VI&#39;</span><span class="p">)</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;time to wait after each state write or query&#39;</span><span class="p">)</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum time to wait for a reply after sending before raising an Exception&#39;</span><span class="p">)</span>
        <span class="n">rx_buffer_size</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span></div>

<div class="viewcode-block" id="LabviewSocketInterface.connect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.LabviewSocketInterface.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tx&#39;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">),</span>
                        <span class="s1">&#39;rx&#39;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;rx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">rx_port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;rx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="LabviewSocketInterface.disconnect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.LabviewSocketInterface.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;could not close socket &#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sock</span><span class="p">))</span></div>

<div class="viewcode-block" id="LabviewSocketInterface.write"><a class="viewcode-back" href="../../labbench.html#labbench.backends.LabviewSocketInterface.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send a string over the tx socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;write {repr(msg)}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;tx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tx_port</span><span class="p">))</span>
        <span class="n">util</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span></div>

    <span class="nd">@state</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send a formatted command string to implement state control.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{trait.command}</span><span class="s1"> </span><span class="si">{value}</span><span class="s1"> &#39;</span><span class="p">)</span>

<div class="viewcode-block" id="LabviewSocketInterface.read"><a class="viewcode-back" href="../../labbench.html#labbench.backends.LabviewSocketInterface.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">convert_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Receive from the rx socket until `self.settings.rx_buffer_size` samples</span>
<span class="sd">            are received or timeout happens after `self.timeout` seconds.</span>

<span class="sd">            Optionally, apply the conversion function to the value after</span>
<span class="sd">            it is received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;rx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">rx_buffer_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;received no data&#39;</span><span class="p">)</span>
        <span class="n">rx_disp</span> <span class="o">=</span> <span class="n">rx</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">))]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;read {repr(rx_disp)}&#39;</span><span class="p">)</span>

        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">convert_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">convert_func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span></div>

<div class="viewcode-block" id="LabviewSocketInterface.clear"><a class="viewcode-back" href="../../labbench.html#labbench.backends.LabviewSocketInterface.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear any data present in the read socket buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">inputready</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="s1">&#39;rx&#39;</span><span class="p">]],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputready</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">inputready</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">continue</span></div></div>


<div class="viewcode-block" id="SerialDevice"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialDevice">[docs]</a><span class="k">class</span> <span class="nc">SerialDevice</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A general base class for communication with serial devices.</span>
<span class="sd">        Unlike (for example) VISA instruments, there is no</span>
<span class="sd">        standardized command format like SCPI. The implementation is</span>
<span class="sd">        therefore limited to connect and disconnect, which open</span>
<span class="sd">        or close a pyserial connection object: the `link` attribute.</span>
<span class="sd">        Subclasses can read or write with the link attribute like they</span>
<span class="sd">        would any other serial instance.</span>

<span class="sd">        A SerialDevice resource string is the same as the</span>
<span class="sd">        platform-dependent `port` argument to new serial.Serial</span>
<span class="sd">        objects.</span>

<span class="sd">        Subclassed devices that need state descriptors will need</span>
<span class="sd">        to implement state_get and state_set methods in order to define</span>
<span class="sd">        how the state descriptors set and get operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SerialDevice.settings"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialDevice.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="c1"># Connection settings</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Max time to wait for a connection before raising TimeoutError.&#39;</span><span class="p">)</span>
        <span class="n">write_termination</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Bytes</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Termination character to send after a write.&#39;</span><span class="p">)</span>
        <span class="n">baud_rate</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">9600</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data rate of the physical serial connection.&#39;</span><span class="p">)</span>
        <span class="n">parity</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Bytes</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Parity in the physical serial connection.&#39;</span><span class="p">)</span>
        <span class="n">stopbits</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of stop bits, one of `[1., 1.5, or 2.]`.&#39;</span><span class="p">)</span>
        <span class="n">xonxoff</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set `True` to enable software flow control.&#39;</span><span class="p">)</span>
        <span class="n">rtscts</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to enable hardware (RTS/CTS) flow control.&#39;</span><span class="p">)</span>
        <span class="n">dsrdtr</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to enable hardware (DSR/DTR) flow control.&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__imports__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">serial</span>
        <span class="kn">import</span> <span class="nn">serial</span>

    <span class="c1"># Overload methods as needed to implement the Device object protocol</span>
<div class="viewcode-block" id="SerialDevice.connect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialDevice.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Connect to the serial device with the VISA resource string defined</span>
<span class="sd">            in self.settings.resource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;parity&#39;</span><span class="p">,</span> <span class="s1">&#39;stopbits&#39;</span><span class="p">,</span>\
               <span class="s1">&#39;xonxoff&#39;</span><span class="p">,</span> <span class="s1">&#39;rtscts&#39;</span><span class="p">,</span> <span class="s1">&#39;dsrdtr&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{repr(self)} connected&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SerialDevice.disconnect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialDevice.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Disconnect the serial instrument</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{repr(self)} disconnected&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SerialDevice.from_hwid"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialDevice.from_hwid">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_hwid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hwid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">connection_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Instantiate a new SerialDevice from a `hwid&#39; resource instead</span>
<span class="sd">            of a comport resource. A hwid string in windows might look something</span>
<span class="sd">            like:</span>

<span class="sd">            r&#39;PCI\\VEN_8086&amp;DEV_9D3D&amp;SUBSYS_06DC1028&amp;REV_21\\3&amp;11583659&amp;1&amp;B3&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">usb_map</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_map_serial_hwid_to_port</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">hwid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usb_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Cannot find serial port with hwid {repr(hwid)}&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">usb_map</span><span class="p">[</span><span class="n">hwid</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">connection_params</span><span class="p">)</span></div>

<div class="viewcode-block" id="SerialDevice.list_ports"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialDevice.list_ports">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">list_ports</span><span class="p">(</span><span class="n">hwid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; List USB serial devices on the computer</span>

<span class="sd">            :return: list of port resource information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">serial.tools</span> <span class="k">import</span> <span class="n">list_ports</span>

        <span class="n">ports</span> <span class="o">=</span> <span class="p">[(</span><span class="n">port</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hwid&#39;</span><span class="p">:</span> <span class="n">port</span><span class="o">.</span><span class="n">hwid</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">port</span><span class="o">.</span><span class="n">description</span><span class="p">})</span>
                 <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">list_ports</span><span class="o">.</span><span class="n">comports</span><span class="p">()]</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hwid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="p">[(</span><span class="n">port</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span> <span class="k">for</span> <span class="n">port</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">ports</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hwid</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_map_serial_hwid_to_label</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot; Map of the comports and their names.</span>

<span class="sd">            :return: mapping {&lt;comport name&gt;: &lt;comport ID&gt;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">serial.tools</span> <span class="k">import</span> <span class="n">list_ports</span>

        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">port</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">list_ports</span><span class="o">.</span><span class="n">comports</span><span class="p">()])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_map_serial_hwid_to_port</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot; Map of the comports and their names.</span>

<span class="sd">            :return: mapping {&lt;comport name&gt;: &lt;comport ID&gt;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">serial.tools</span> <span class="k">import</span> <span class="n">list_ports</span>

        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">port</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">list_ports</span><span class="o">.</span><span class="n">comports</span><span class="p">()])</span></div>


<div class="viewcode-block" id="SerialLoggingDevice"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialLoggingDevice">[docs]</a><span class="k">class</span> <span class="nc">SerialLoggingDevice</span><span class="p">(</span><span class="n">SerialDevice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Manage connection, acquisition, and data retreival on a single GPS device.</span>
<span class="sd">        The goal is to make GPS devices controllable somewhat like instruments:</span>
<span class="sd">        maintaining their own threads, and blocking during setup or stop</span>
<span class="sd">        command execution.</span>

<span class="sd">        Listener objects must implement an attach method with one argument</span>
<span class="sd">        consisting of the queue that the device manager uses to push data</span>
<span class="sd">        from the serial port.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SerialLoggingDevice.settings"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialLoggingDevice.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">SerialDevice</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">poll_rate</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data retreival rate from the device (in seconds)&#39;</span><span class="p">)</span>
        <span class="n">data_format</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Bytes</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data format metadata&#39;</span><span class="p">)</span>
        <span class="n">stop_timeout</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Delay after a call to `stop` before terminating the runloop thread&#39;</span><span class="p">)</span>
        <span class="n">max_queue_size</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of bytes to allocate in the data retreival buffer&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SerialLoggingDevice.configure"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialLoggingDevice.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This is called at the beginning of the logging thread that runs</span>
<span class="sd">            on a call to `start`.</span>

<span class="sd">            This is a stub that does nothing --- it should be implemented by a</span>
<span class="sd">            subclass for a specific serial logger device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;{repr(self)}: no device-specific configuration implemented&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SerialLoggingDevice.start"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialLoggingDevice.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Start a background thread that acquires log data into a queue.</span>

<span class="sd">            :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">serial</span> <span class="k">import</span> <span class="n">SerialException</span>

        <span class="k">def</span> <span class="nf">accumulate</span><span class="p">():</span>
            <span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span>
            <span class="n">stop_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{repr(self)}: configuring log acquisition&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{repr(self)}: starting log acquisition&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">stop_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">poll_rate</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                        <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">baud_rate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">poll_rate</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{repr(self)} ending log acquisition&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;already running&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">accumulate</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="SerialLoggingDevice.stop"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialLoggingDevice.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Stops the logger acquisition if it is running. Returns silently otherwise.</span>

<span class="sd">            :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="SerialLoggingDevice.running"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialLoggingDevice.running">[docs]</a>    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check whether the logger is running.</span>

<span class="sd">            :returns: `True` if the logger is running</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_stop&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span></div>

<div class="viewcode-block" id="SerialLoggingDevice.fetch"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialLoggingDevice.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve and return any log data in the buffer.</span>

<span class="sd">            :returns: any bytes in the buffer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="SerialLoggingDevice.clear"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialLoggingDevice.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Throw away any log data in the buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span></div>

<div class="viewcode-block" id="SerialLoggingDevice.disconnect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.SerialLoggingDevice.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TelnetDevice"><a class="viewcode-back" href="../../labbench.html#labbench.backends.TelnetDevice">[docs]</a><span class="k">class</span> <span class="nc">TelnetDevice</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A general base class for communication devices via telnet.</span>
<span class="sd">        Unlike (for example) VISA instruments, there is no</span>
<span class="sd">        standardized command format like SCPI. The implementation is</span>
<span class="sd">        therefore limited to connect and disconnect, which open</span>
<span class="sd">        or close a pyserial connection object: the `backend` attribute.</span>
<span class="sd">        Subclasses can read or write with the backend attribute like they</span>
<span class="sd">        would any other telnetlib instance.</span>

<span class="sd">        A TelnetDevice `resource` string is an IP address. The port is specified</span>
<span class="sd">        by `port`. These can be set when you instantiate the TelnetDevice</span>
<span class="sd">        or by setting them afterward in `settings`.</span>

<span class="sd">        Subclassed devices that need state descriptors will need</span>
<span class="sd">        to implement `state.getter` and `state.setter` methods to implement</span>
<span class="sd">        the state set and get operations (as appropriate).</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TelnetDevice.settings"><a class="viewcode-back" href="../../labbench.html#labbench.backends.TelnetDevice.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="c1"># Connection settings</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum time to wait for a connection before &#39;</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__imports__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">Telnet</span>
        <span class="kn">from</span> <span class="nn">telnetlib</span> <span class="k">import</span> <span class="n">Telnet</span>

<div class="viewcode-block" id="TelnetDevice.connect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.TelnetDevice.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make the telnet connection to the host defined</span>
<span class="sd">            by the string in self.settings.resource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">Telnet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                              <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="TelnetDevice.disconnect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.TelnetDevice.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Disconnect the telnet connection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="VISADevice"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice">[docs]</a><span class="k">class</span> <span class="nc">VISADevice</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; .. class:: VISADevice(resource, read_termination=&#39;\\n&#39;, write_termination=&#39;\\n&#39;)</span>

<span class="sd">        VISADevice instances control VISA instruments using a</span>
<span class="sd">        pyvisa backend. Compared to direct use of pyvisa, this</span>
<span class="sd">        style of use permits use of labbench device `state`</span>
<span class="sd">        goodies for compact, readable code, as well as type checking.</span>

<span class="sd">        For example, the following fetches the</span>
<span class="sd">        identity string from the remote instrument::</span>

<span class="sd">            with VISADevice(&#39;USB0::0x2A8D::0x1E01::SG56360004::INSTR&#39;) as instr:</span>
<span class="sd">                print inst.state.identity</span>

<span class="sd">        This is equivalent to the more pyvisa-style use as follows::</span>

<span class="sd">            inst = VISADevice(&#39;USB0::0x2A8D::0x1E01::SG56360004::INSTR&#39;)</span>
<span class="sd">            inst.connect()</span>
<span class="sd">            print inst.query(&#39;*IDN?&#39;)</span>

<span class="sd">        Use of `inst.state` makes it possible to add callbacks to support</span>
<span class="sd">        automatic state logging, or to build a UI.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="VISADevice.state"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.state">[docs]</a>    <span class="k">class</span> <span class="nc">state</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">state</span><span class="p">):</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;*IDN&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;identity string reported by the instrument&#39;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;*OPT&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s1">&#39;options reported by the instrument&#39;</span><span class="p">)</span>
        <span class="n">status_byte</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;*STB&#39;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;VISA status byte reported by the instrument&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="VISADevice.settings"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">read_termination</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="s1">&#39;connected&#39;</span><span class="p">,</span>
                                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;termination character to indicate end of message on receive from the instrument&#39;</span><span class="p">)</span>
        <span class="n">write_termination</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="s1">&#39;connected&#39;</span><span class="p">,</span>
                                         <span class="n">help</span><span class="o">=</span><span class="s1">&#39;termination character to indicate end of message in messages sent to the instrument&#39;</span><span class="p">)</span></div>

    <span class="n">__opc</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Whether or not to append ;*OPC to each call to write()</span>
    <span class="n">_rm</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__imports__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">pyvisa</span>
        <span class="kn">import</span> <span class="nn">pyvisa</span>
        <span class="kn">import</span> <span class="nn">pyvisa.constants</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">set_backend</span><span class="p">(</span><span class="s1">&#39;@ni&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__release_remote_control</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Found this in a mixture of R&amp;S documentation and goofle-fu on pyvisa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">visalib</span><span class="o">.</span><span class="n">viGpibControlREN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                                              <span class="n">pyvisa</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">VI_GPIB_REN_ADDRESS_GTL</span><span class="p">)</span>

    <span class="c1"># Overload methods as needed to implement RemoteDevice</span>
<div class="viewcode-block" id="VISADevice.connect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Connect to the VISA instrument defined by the VISA resource</span>
<span class="sd">            set by `self.settings.resource`. The pyvisa backend object is assigned</span>
<span class="sd">            to `self.backend`.</span>

<span class="sd">            :returns: None</span>

<span class="sd">            Instead of calling `connect` directly, consider using</span>
<span class="sd">            `with` statements to guarantee proper disconnection</span>
<span class="sd">            if there is an error. For example, the following</span>
<span class="sd">            sets up a connected instance::</span>

<span class="sd">                with VISADevice(&#39;USB0::0x2A8D::0x1E01::SG56360004::INSTR&#39;) as inst:</span>
<span class="sd">                    print inst.state.identity</span>
<span class="sd">                    print inst.state.status_byte</span>
<span class="sd">                    print inst.state.options</span>

<span class="sd">            would instantiate a `VISADevice` and guarantee</span>
<span class="sd">            it is disconnected either at the successful completion</span>
<span class="sd">            of the `with` block, or if there is any exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The resource manager is &quot;global&quot; at the class level here</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VISADevice</span><span class="o">.</span><span class="n">_rm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">VISADevice</span><span class="o">.</span><span class="n">_rm</span> <span class="o">=</span> <span class="n">pyvisa</span><span class="o">.</span><span class="n">ResourceManager</span><span class="p">(</span><span class="s1">&#39;@ni&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> \
                <span class="p">(</span>
                    <span class="s1">&#39;labbench VISA support requires NI VISA; is it installed?</span><span class="se">\n</span><span class="s1">http://download.ni.com/support/softlib/visa/NI-VISA/16.0/Windows/NIVISA1600runtime.exe&#39;</span><span class="p">,)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">VISADevice</span><span class="o">.</span><span class="n">_rm</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
                                                    <span class="n">read_termination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">read_termination</span><span class="p">,</span>
                                                    <span class="n">write_termination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">write_termination</span><span class="p">)</span></div>

<div class="viewcode-block" id="VISADevice.disconnect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Disconnect the VISA instrument. If you use a `with` block</span>
<span class="sd">            this is handled automatically and you do not need to</span>
<span class="sd">            call this method.</span>

<span class="sd">            :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">pyvisa</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">VisaIOError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__release_remote_control</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">pyvisa</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;unhandled disconnect error: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="VISADevice.set_backend"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.set_backend">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_backend</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">backend_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the pyvisa resource manager for all VISA objects.</span>

<span class="sd">            :param backend_name str: &#39;@ni&#39; (the default) or &#39;@py&#39;</span>
<span class="sd">            :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">VISADevice</span><span class="o">.</span><span class="n">_rm</span> <span class="o">=</span> <span class="n">pyvisa</span><span class="o">.</span><span class="n">ResourceManager</span><span class="p">(</span><span class="n">backend_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="VISADevice.list_resources"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.list_resources">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">list_resources</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; List the resource strings of the available devices sensed by the VISA backend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__imports__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rm</span><span class="o">.</span><span class="n">list_resources</span><span class="p">()</span></div>

<div class="viewcode-block" id="VISADevice.write"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write an SCPI command to the device with pyvisa.</span>

<span class="sd">            Handles debug logging and adjustments when in overlap_and_block</span>
<span class="sd">            contexts as appropriate.</span>

<span class="sd">            :param str msg: the SCPI command to send by VISA</span>
<span class="sd">            :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__opc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;;*OPC&#39;</span>
        <span class="n">msg_out</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="k">else</span> <span class="n">f</span><span class="s1">&#39;({len(msg)} bytes)&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;write {repr(msg_out)}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="VISADevice.query"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Query an SCPI command to the device with pyvisa,</span>
<span class="sd">            and return a string containing the device response.</span>

<span class="sd">            Handles debug logging and adjustments when in overlap_and_block</span>
<span class="sd">            contexts as appropriate.</span>

<span class="sd">            :param str msg: the SCPI command to send by VISA</span>
<span class="sd">            :returns: the response to the query from the device</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_to</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">timeout</span>
        <span class="n">msg_out</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">80</span> <span class="k">else</span> <span class="n">f</span><span class="s1">&#39;({len(msg)} bytes)&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;query {repr(msg_out)}&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">_to</span>
        <span class="n">msg_out</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">80</span> <span class="k">else</span> <span class="n">f</span><span class="s1">&#39;({len(msg)} bytes)&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;      -&gt; </span><span class="si">{msg_out}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="nd">@state</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send an SCPI command to get a state value from the</span>
<span class="sd">            device. This function</span>
<span class="sd">            adds a &#39;?&#39; to match SCPI convention. This is</span>
<span class="sd">            automatically called for `state` attributes that</span>
<span class="sd">            define a message.</span>

<span class="sd">            :param str command: The SCPI command to send</span>
<span class="sd">            :param trait: The trait state corresponding with the command (ignored)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

    <span class="nd">@state</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send an SCPI command to set a state value on the</span>
<span class="sd">            device. This function adds a &#39;?&#39; to match SCPI convention. This is</span>
<span class="sd">            automatically called for `state` attributes that</span>
<span class="sd">            define a message.</span>

<span class="sd">            :param str command: The SCPI command to send</span>
<span class="sd">            :param trait: The trait state corresponding with the command (ignored)</span>
<span class="sd">            :param str value: The value to assign to the parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

<div class="viewcode-block" id="VISADevice.wait"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience function to send standard SCPI &#39;\\*WAI&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*WAI&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="VISADevice.preset"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.preset">[docs]</a>    <span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience function to send standard SCPI &#39;\\*RST&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*RST&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="VISADevice.overlap_and_block"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.overlap_and_block">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">overlap_and_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A request is sent to the instrument to overlap all of the</span>
<span class="sd">            VISA commands written while in this context. At the end</span>
<span class="sd">            of the block, wait until the instrument confirms that all</span>
<span class="sd">            operations have finished. This is the standard VISA &#39;;\\*OPC&#39;</span>
<span class="sd">            and &#39;\\*OPC?&#39; behavior.</span>

<span class="sd">            This is meant to be used in `with` blocks as follows::</span>

<span class="sd">                with inst.overlap_and_block():</span>
<span class="sd">                    inst.write(&#39;long running command 1&#39;)</span>
<span class="sd">                    inst.write(&#39;long running command 2&#39;)</span>

<span class="sd">            The wait happens on leaving the `with` block.</span>

<span class="sd">            :param timeout: delay (in milliseconds) on waiting for the instrument to finish the overlapped commands before a TimeoutError after leaving the `with` block. If `None`, use self.backend.timeout.</span>
<span class="sd">            :param quiet: Suppress timeout exceptions if this evaluates as True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__opc</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__opc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;*OPC?&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="VISADevice.suppress_timeout"><a class="viewcode-back" href="../../labbench.html#labbench.backends.VISADevice.suppress_timeout">[docs]</a>    <span class="k">class</span> <span class="nc">suppress_timeout</span><span class="p">(</span><span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Context manager to suppress timeout exceptions.</span>
<span class="sd">        </span>
<span class="sd">            Example::</span>
<span class="sd">                </span>
<span class="sd">                with inst.suppress_timeout():</span>
<span class="sd">                    inst.write(&#39;long running command 1&#39;)</span>
<span class="sd">                    inst.write(&#39;long running command 2&#39;)</span>

<span class="sd">            If the command 1 raises an exception, then command 2 will (silently)</span>
<span class="sd">            not execute.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exctype</span><span class="p">,</span> <span class="n">excinst</span><span class="p">,</span> <span class="n">exctb</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">exctype</span> <span class="o">==</span> <span class="n">pyvisa</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">VisaIOError</span> \
                <span class="ow">and</span> <span class="n">excinst</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">pyvisa</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">StatusCode</span><span class="o">.</span><span class="n">error_timeout</span></div>

    <span class="nd">@state</span><span class="o">.</span><span class="n">status_byte</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;*STB?&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error queue not empty&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mb">0b00000100</span><span class="p">),</span>
                <span class="s1">&#39;questionable state&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mb">0b00001000</span><span class="p">),</span>
                <span class="s1">&#39;message available&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mb">0b00010000</span><span class="p">),</span>
                <span class="s1">&#39;event status flag&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mb">0b00100000</span><span class="p">),</span>
                <span class="s1">&#39;service request&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mb">0b01000000</span><span class="p">),</span>
                <span class="s1">&#39;master status summary&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mb">0b01000000</span><span class="p">),</span>
                <span class="s1">&#39;operating&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mb">0b10000000</span><span class="p">),</span>
                <span class="p">}</span></div>


<div class="viewcode-block" id="EmulatedVISADevice"><a class="viewcode-back" href="../../labbench.html#labbench.backends.EmulatedVISADevice">[docs]</a><span class="k">class</span> <span class="nc">EmulatedVISADevice</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Act as a VISA device without dispatching any visa commands</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">generators</span> <span class="o">=</span> <span class="p">{</span><span class="n">core</span><span class="o">.</span><span class="n">Bool</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">trait</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">_trues</span> <span class="o">+</span> <span class="n">trait</span><span class="o">.</span><span class="n">_falses</span><span class="p">)),</span>
                  <span class="n">core</span><span class="o">.</span><span class="n">Bytes</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">trait</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                  <span class="n">core</span><span class="o">.</span><span class="n">Float</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">trait</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">trait</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">trait</span><span class="o">.</span><span class="n">max</span><span class="p">)),</span> <span class="p">}</span>

<div class="viewcode-block" id="EmulatedVISADevice.state"><a class="viewcode-back" href="../../labbench.html#labbench.backends.EmulatedVISADevice.state">[docs]</a>    <span class="k">class</span> <span class="nc">state</span><span class="p">(</span><span class="n">VISADevice</span><span class="o">.</span><span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="EmulatedVISADevice.settings"><a class="viewcode-back" href="../../labbench.html#labbench.backends.EmulatedVISADevice.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">VISADevice</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="k">pass</span></div>


        <span class="c1"># #        # Spoof the remote responses for some built-in VISA items</span>
        <span class="c1"># status_byte = core.Unicode(default_value=&#39;0&#39;, read_only=True)</span>
        <span class="c1"># identity = core.Unicode(</span>
        <span class="c1">#     default_value=&#39;Emulated VISA Device&#39;, read_only=True, is_metadata=True)</span>
        <span class="c1"># options = core.Unicode(</span>
        <span class="c1">#     default_value=&#39;Terrific Options&#39;, read_only=True, is_metadata=True)</span>

    <span class="c1"># Overload methods as needed to implement RemoteDevice</span>
<div class="viewcode-block" id="EmulatedVISADevice.set_backend"><a class="viewcode-back" href="../../labbench.html#labbench.backends.EmulatedVISADevice.set_backend">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_backend</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">backend_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; backend_name can be &#39;py&#39; or &#39;ni&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="EmulatedVISADevice.connect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.EmulatedVISADevice.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span></div>

<div class="viewcode-block" id="EmulatedVISADevice.disconnect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.EmulatedVISADevice.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="nd">@state</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">trait</span><span class="p">)](</span><span class="n">trait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="n">trait</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@state</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="n">trait</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Win32ComDevice"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Win32ComDevice">[docs]</a><span class="k">class</span> <span class="nc">Win32ComDevice</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Basic support for calling win32 COM APIs.</span>

<span class="sd">        The python wrappers for COM drivers still basically require that</span>
<span class="sd">        threading is performed using the windows COM API, and not the python</span>
<span class="sd">        threading. Figuring this out with win32com calls within python is</span>
<span class="sd">        not for the faint of heart. Threading support is instead realized</span>
<span class="sd">        with util.ThreadSandbox, which ensures that all calls to the dispatched</span>
<span class="sd">        COM object block until the previous calls are completed from within</span>
<span class="sd">        a background thread. Set concurrency_support=True to decide whether</span>
<span class="sd">        this thread support wrapper is applied to the dispatched Win32Com object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Win32ComDevice.settings"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Win32ComDevice.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="o">.</span><span class="n">settings</span><span class="p">):</span>
        <span class="n">com_object</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the win32com object string&#39;</span><span class="p">)</span>  <span class="c1"># Must be a module</span>
        <span class="n">concurrency_support</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;whether this :class:`Device` implementation supports threading&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__imports__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">win32com</span>
        <span class="kn">import</span> <span class="nn">win32com</span>
        <span class="kn">import</span> <span class="nn">win32com.client</span>

<div class="viewcode-block" id="Win32ComDevice.connect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Win32ComDevice.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Connect to the win32 com object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">should_sandbox</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">win32com</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">factory</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">pythoncom</span> <span class="k">import</span> <span class="n">CoInitialize</span>
            <span class="n">CoInitialize</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">win32com</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">Dispatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">com_object</span><span class="p">)</span>

        <span class="c1"># Oddness for win32 threadsafety</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">coinit_flags</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">com_object</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;settings.com_object needs to be set&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">concurrency_support</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">ThreadSandbox</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">should_sandbox</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">win32com</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">Dispatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">com_object</span><span class="p">)</span></div>

<div class="viewcode-block" id="Win32ComDevice.disconnect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Win32ComDevice.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench v0.20</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
<hr \>
<section class="footer">
<br><a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#privpolicy">Privacy Policy</a> | <a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#secnot">Security Notice</a> | <a href="http://www.nist.gov/public_affairs/privacy.cfm#accesstate">Accessibility Statement</a>
<br><em>United States government work, not subject to copyright in the United States</em>
</section>

  </body>
</html>