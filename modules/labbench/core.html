
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>labbench.core &#8212; labbench v0.20</title>
    <link rel="stylesheet" href="../../static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
<header class="nist-header">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>NIST Pages Template</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="labbench v0.20">
  <link rel="canonical" href="../../">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Google Analytics -->
  <!--<script type="text/javascript" id="_fed_an_js_tag" src="http://www.nist.gov/js/federated-analytics.all.min.js?agency=NIST&subagency=mml&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script> -->
  <!-- DAP Analytics -->
  <script type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&subagefncy=NIST&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../..//_static/NISTStyle.css">
  <link rel="stylesheet" href="../..//_static/NISTPages.css">

  <h1>
    <a class="nist-logo" target="_blank" href="http://www.nist.gov/" title="Go to nist.gov">National Institute of Standards and Technology</a>
  </h1>
  <div class="nist-links">
    <a class="nist-links-button" target="_blank" href="http://www.nist.gov">NIST Website</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="http://www.nist.gov/public_affairs/nandyou.cfm">About NIST</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="https://github.com/usnistgov">usnistgov on GitHub</a>
  </div>
  
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</header>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench v0.20</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for labbench.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># This software was developed by employees of the National Institute of</span>
<span class="c1"># Standards and Technology (NIST), an agency of the Federal Government.</span>
<span class="c1"># Pursuant to title 17 United States Code Section 105, works of NIST employees</span>
<span class="c1"># are not subject to copyright protection in the United States and are</span>
<span class="c1"># considered to be in the public domain. Permission to freely use, copy,</span>
<span class="c1"># modify, and distribute this software and its documentation without fee is</span>
<span class="c1"># hereby granted, provided that this notice and disclaimer of warranty appears</span>
<span class="c1"># in all copies.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &#39;AS IS&#39; WITHOUT ANY WARRANTY OF ANY KIND, EITHER</span>
<span class="c1"># EXPRESSED, IMPLIED, OR STATUTORY, INCLUDING, BUT NOT LIMITED TO, ANY WARRANTY</span>
<span class="c1"># THAT THE SOFTWARE WILL CONFORM TO SPECIFICATIONS, ANY IMPLIED WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND FREEDOM FROM</span>
<span class="c1"># INFRINGEMENT, AND ANY WARRANTY THAT THE DOCUMENTATION WILL CONFORM TO THE</span>
<span class="c1"># SOFTWARE, OR ANY WARRANTY THAT THE SOFTWARE WILL BE ERROR FREE. IN NO EVENT</span>
<span class="c1"># SHALL NIST BE LIABLE FOR ANY DAMAGES, INCLUDING, BUT NOT LIMITED TO, DIRECT,</span>
<span class="c1"># INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES, ARISING OUT OF, RESULTING FROM,</span>
<span class="c1"># OR IN ANY WAY CONNECTED WITH THIS SOFTWARE, WHETHER OR NOT BASED UPON</span>
<span class="c1"># WARRANTY, CONTRACT, TORT, OR OTHERWISE, WHETHER OR NOT INJURY WAS SUSTAINED</span>
<span class="c1"># BY PERSONS OR PROPERTY OR OTHERWISE, AND WHETHER OR NOT LOSS WAS SUSTAINED</span>
<span class="c1"># FROM, OR AROSE OUT OF THE RESULTS OF, OR USE OF, THE SOFTWARE OR SERVICES</span>
<span class="c1"># PROVIDED HEREUNDER. Distributions of NIST software should also include</span>
<span class="c1"># copyright and licensing statements of any third-party software that are</span>
<span class="c1"># legally bundled with the code in compliance with the conditions of those</span>
<span class="c1"># licenses.</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This implementation is deeply intertwined with low-level internals of</span>
<span class="sd">traitlets and obscure details of the python object model. Consider reading</span>
<span class="sd">the documentation closely and inheriting these objects instead of</span>
<span class="sd">reverse-engineering this code.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">util</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="k">import</span> <span class="n">dedent</span>

<span class="kn">import</span> <span class="nn">traitlets</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">traitlets</span> <span class="k">import</span> <span class="n">All</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="n">TraitType</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ConnectionError&#39;</span><span class="p">,</span> <span class="s1">&#39;DeviceException&#39;</span><span class="p">,</span> <span class="s1">&#39;DeviceNotReady&#39;</span><span class="p">,</span> <span class="s1">&#39;DeviceFatalError&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;DeviceConnectionLost&#39;</span><span class="p">,</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">,</span> <span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="s1">&#39;DeviceStateError&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Int&#39;</span><span class="p">,</span> <span class="s1">&#39;Float&#39;</span><span class="p">,</span> <span class="s1">&#39;Unicode&#39;</span><span class="p">,</span> <span class="s1">&#39;Complex&#39;</span><span class="p">,</span> <span class="s1">&#39;Bytes&#39;</span><span class="p">,</span> <span class="s1">&#39;CaselessBytesEnum&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Bool&#39;</span><span class="p">,</span> <span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="s1">&#39;Dict&#39;</span><span class="p">,</span> <span class="s1">&#39;TCPAddress&#39;</span><span class="p">,</span>
           <span class="s1">&#39;CaselessStrEnum&#39;</span><span class="p">,</span> <span class="s1">&#39;Device&#39;</span><span class="p">,</span> <span class="s1">&#39;list_devices&#39;</span><span class="p">,</span> <span class="s1">&#39;logger&#39;</span><span class="p">,</span> <span class="s1">&#39;CommandNotImplementedError&#39;</span><span class="p">,</span>
           <span class="p">]</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;labbench&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="ConnectionError"><a class="viewcode-back" href="../../labbench.html#labbench.backends.ConnectionError">[docs]</a><span class="k">class</span> <span class="nc">ConnectionError</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Failure on attempt to connect to a device</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DeviceStateError"><a class="viewcode-back" href="../../labbench.html#labbench.backends.DeviceStateError">[docs]</a><span class="k">class</span> <span class="nc">DeviceStateError</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Failure to get or set a state in `Device.state`</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DeviceNotReady"><a class="viewcode-back" href="../../labbench.html#labbench.backends.DeviceNotReady">[docs]</a><span class="k">class</span> <span class="nc">DeviceNotReady</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Failure to communicate with the Device because it was not ready for communication</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DeviceException"><a class="viewcode-back" href="../../labbench.html#labbench.backends.DeviceException">[docs]</a><span class="k">class</span> <span class="nc">DeviceException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generic Device exception</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DeviceFatalError"><a class="viewcode-back" href="../../labbench.html#labbench.backends.DeviceFatalError">[docs]</a><span class="k">class</span> <span class="nc">DeviceFatalError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A fatal error in the device</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DeviceConnectionLost"><a class="viewcode-back" href="../../labbench.html#labbench.backends.DeviceConnectionLost">[docs]</a><span class="k">class</span> <span class="nc">DeviceConnectionLost</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Connection state has been lost unexpectedly</span>
<span class="sd">    &quot;&quot;&quot;</span>    </div>


<div class="viewcode-block" id="CommandNotImplementedError"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CommandNotImplementedError">[docs]</a><span class="k">class</span> <span class="nc">CommandNotImplementedError</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A command that has been defined but not implemented</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="k">class</span> <span class="nc">MetaHasTraits</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">MetaHasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A metaclass for documenting HasTraits.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setup_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">classdict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_class</span><span class="p">(</span><span class="n">classdict</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">__rawdoc__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Find the documentation for HasTraits</span>
            <span class="k">for</span> <span class="n">subcls</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subcls</span><span class="p">,</span> <span class="s1">&#39;__rawdoc__&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">subcls</span><span class="o">.</span><span class="n">__rawdoc__</span><span class="p">:</span>
                        <span class="n">doc</span> <span class="o">=</span> <span class="n">subcls</span><span class="o">.</span><span class="n">__rawdoc__</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span>

        <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_doc_traits</span><span class="p">()])</span>


<span class="k">class</span> <span class="nc">HasTraits</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">HasTraits</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MetaHasTraits</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Base class for accessing the local and remote state</span>
<span class="sd">        parameters of a device.  Normally,</span>
<span class="sd">        a device driver implemented as a :class:`Device` subclass</span>
<span class="sd">        should add driver-specific states by subclassing this class.</span>

<span class="sd">        Instantiating :class:`Device` (or one of its subclasses)</span>
<span class="sd">        automatically instantiate this class as well.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">_device</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__attributes__</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">HasTraits</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">HasTraits</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getter__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CommandNotImplementedError</span>

    <span class="k">def</span> <span class="nf">__setter__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CommandNotImplementedError</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_doc_traits</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :return: a dictionary of documentation for this class&#39;s traits</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">trait attributes:&#39;</span><span class="p">]</span>
        <span class="n">traits</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">class_traits</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">traits</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;* `</span><span class="si">{name}</span><span class="s1">`: `</span><span class="si">{type}</span><span class="s1">`&#39;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="n">trait</span><span class="o">.</span><span class="n">help</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="n">trait</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HasSettingsTraits</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Change default values of the settings in parent settings, without redefining the</span>
<span class="sd">            full class. redefined according to each keyword argument. For example::</span>

<span class="sd">                MyInstrumentClass.settings.define(parameter=7)</span>

<span class="sd">            changes the default value of the `parameter` setting in `MyInstrumentClass.settings` to `7`.</span>
<span class="sd">            This is a convenience function to avoid completely redefining `parameter` if it was defined</span>
<span class="sd">            in a parent class of `MyInstrumentClass`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Dynamically define the result to be a new subclass</span>
        <span class="n">newcls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,),</span> <span class="p">{})</span>

        <span class="n">traits</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">class_traits</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">traits</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span><span class="p">(</span><span class="s1">&#39;cannot set default value of undefined trait </span><span class="si">{}</span><span class="s1">&#39;</span>
                                           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">traits</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">trait</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">v</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">newcls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newcls</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Prevent silent errors that could result from typos in state names</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># Need to check self.__attributes__ because traitlets.HasTraits.__init__ may not</span>
        <span class="c1"># have created attributes it needs yet</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__attributes__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has no &#39;</span><span class="si">{}</span><span class="s2">&#39; setting defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> attribute &#39;</span><span class="si">{}</span><span class="s2">&#39; is a method, not a setting. call as a function it instead&quot;</span>\
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HasSettingsTraits</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HasStateTraits</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Use this as a decorator to define a setter function for all traits</span>
<span class="sd">            in this class. The setter should take two arguments: the instance</span>
<span class="sd">            of the trait to get, and the value to set. It should perform any</span>
<span class="sd">            operation needed to apply the given value to the trait&#39;s state</span>
<span class="sd">            in `self._device`. One example is to send a command defined by</span>
<span class="sd">            trait.command.</span>

<span class="sd">            Any return value from the function is ignored.</span>

<span class="sd">            A trait that has its own setter defined will ignore this</span>
<span class="sd">            one.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__setter__</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="bp">cls</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Use this as a decorator to define a setter function for all traits</span>
<span class="sd">            in this class. The getter should take one argument: the instance</span>
<span class="sd">            of the trait to get. It should perform any</span>
<span class="sd">            operation needed to retrieve the current value of the device state</span>
<span class="sd">            corresponding to the supplied trait, using `self._device`.</span>

<span class="sd">            One example is to send a command defined by</span>
<span class="sd">            trait.command.</span>

<span class="sd">            The function should return a value that is the state from the</span>
<span class="sd">            device.</span>

<span class="sd">            A trait that has its own getter defined will ignore this</span>
<span class="sd">            one.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__getter__</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Prevent silent errors that could result from typos in state names</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">exists</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># Need to check self.__attributes__ because traitlets.HasTraits.__init__ may not</span>
        <span class="c1"># have created attributes it needs yet</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__attributes__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has no &#39;</span><span class="si">{}</span><span class="s2">&#39; state definition&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> attribute &#39;</span><span class="si">{}</span><span class="s2">&#39; is a method, not a state. call as a function it instead&quot;</span>\
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HasStateTraits</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remap</span><span class="o">=</span><span class="p">{})</span>

<span class="k">class</span> <span class="nc">TraitMixIn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Includes added mix-in features for device control into traitlets types:</span>
<span class="sd">        - If the instance is an attribute of a HasStateTraits class, there are hooks for</span>
<span class="sd">          live synchronization with the remote device by sending or receiving data.</span>
<span class="sd">          Implement with one of</span>
<span class="sd">          * `getter` and/or `setter` keywords in __init__ to pass in a function;</span>
<span class="sd">          *  metadata passed in through the `command` keyword, which the parent</span>
<span class="sd">             HasStateTraits instance may use in its own `getter` and `setter`</span>
<span class="sd">             implementations</span>
<span class="sd">        - Adds metadata for autogenerating documentation (see `doc_attrs`)</span>

<span class="sd">        Order is important - the class should inherit TraitMixIn first and the</span>
<span class="sd">        desired traitlet type second.</span>

<span class="sd">        class LabbenchType(TraitMixIn,traitlets.TraitletType):</span>
<span class="sd">            pass</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">doc_attrs</span> <span class="o">=</span> <span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;read_only&#39;</span><span class="p">,</span> <span class="s1">&#39;write_only&#39;</span><span class="p">,</span> <span class="s1">&#39;remap&#39;</span><span class="p">,</span> <span class="s1">&#39;cache&#39;</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">Undefined</span>
    <span class="n">write_only</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">read_only_if_connected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">write_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">getter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">remap</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">make_doc</span><span class="p">():</span>
            <span class="n">attr_pairs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_attrs</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">def_k</span><span class="p">,</span> <span class="n">def_v</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">def_k</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="n">def_v</span><span class="p">:</span>
                        <span class="c1"># Don&#39;t doc the default values</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">attr_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{k}</span><span class="s1">={repr(v)}&#39;</span><span class="p">)</span>
                <span class="c1"># if (k==&#39;default_value&#39; and v == Undefined)\</span>
                <span class="c1">#    or (k==&#39;read_only&#39; and v == False)\</span>
                <span class="c1">#    or (k==&#39;write_only&#39; and v == False)\</span>
                <span class="c1">#    or (k==&#39;cache&#39; and v == False)\</span>
                <span class="c1">#    or (k==&#39;allow_none&#39; and v==False):</span>
                <span class="c1">#     continue</span>
                <span class="c1"># if v is None\</span>
                <span class="c1">#    or (k==&#39;remap&#39; and v=={}):</span>
                <span class="c1">#     continue</span>
                <span class="c1"># if (k==&#39;default_value&#39; and v!=Undefined)\</span>
                <span class="c1">#    and v is not None\</span>
                <span class="c1">#    and not (k==&#39;allow_none&#39; and v==False)\</span>
                <span class="c1">#    and not (k==&#39;remap&#39; and v=={}):</span>
                
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                      <span class="s1">&#39;attrs&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr_pairs</span><span class="p">),</span>
                      <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span><span class="p">}</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">(</span><span class="si">{attrs}</span><span class="s1">)</span><span class="se">\n\n\t</span><span class="si">{help}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\*&#39;</span><span class="p">)</span>
            <span class="c1"># if self.__doc__:</span>
            <span class="c1">#     sig += self.__doc__</span>
            <span class="k">return</span> <span class="n">sig</span>

        <span class="c1"># Identify the underlying class from Trait</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">TraitType</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">TraitMixIn</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">c</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;could not identify any parent Trait class&#39;</span><span class="p">)</span>

        <span class="c1"># Work around a bug in traitlets.List as of version 4.3.2</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">Container</span><span class="p">)</span>\
           <span class="ow">and</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">default_value</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="n">default_value</span><span class="p">,</span>
                                         <span class="n">allow_none</span><span class="o">=</span><span class="n">allow_none</span><span class="p">,</span>
                                         <span class="n">read_only</span><span class="o">=</span><span class="n">read_only</span><span class="p">,</span>
                                         <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">read_only</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
            <span class="n">read_only</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_only_if_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">write_only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_only</span> <span class="o">=</span> <span class="n">write_only</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remap</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;remap must be a dictionary&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__last</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">setter</span><span class="o">=</span><span class="n">setter</span><span class="p">,</span>
                 <span class="n">getter</span><span class="o">=</span><span class="n">getter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remap</span> <span class="o">=</span> <span class="n">remap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remap_inbound</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">remap</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">make_doc</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Overload the traitlet&#39;s get method. If `obj` is a HasSettingsTraits, call HasTraits.get</span>
<span class="sd">            like normal. Otherwise, this is a HasStateTraits, and inject a call to do a `set` from the remote device</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># If this is Device.settings instead of Device.state, do simple Trait.get,</span>
        <span class="c1"># skipping any communicate with the device</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HasSettingsTraits</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HasStateTraits</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;obj (of type </span><span class="si">{}</span><span class="s1">) must be an instance of HasSettingsTraits or HasStateTraits&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>

        <span class="c1"># If self.write_only, bail if we haven&#39;t cached the value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">TraitError</span><span class="p">(</span>
                <span class="s1">&#39;tried to get state value, but it is write-only and has not been set yet&#39;</span><span class="p">)</span>

        <span class="c1"># If self.write_only or we are caching, return a cached value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_only</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last</span>

        <span class="c1"># First, look for a getter function or method that implements getting</span>
        <span class="c1"># the value from the device</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;getter&#39;</span><span class="p">]):</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;getter&#39;</span><span class="p">](</span><span class="n">obj</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>

        <span class="c1"># If there is no getter function, try calling the command_get() method in the Device instance.</span>
        <span class="c1"># Otherwise, raise an exception, because we don&#39;t know how to get the</span>
        <span class="c1"># value from the Device.</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># self.command is not None:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__getter__</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_device</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CommandNotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DeviceStateError</span><span class="p">(</span>
                    <span class="s1">&#39;no command or getter defined - cannot get state from device&#39;</span><span class="p">)</span>

        <span class="c1"># Remap the resulting value.</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remap_inbound</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

        <span class="c1"># Apply the value with the parent traitlet class.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Overload the traitlet&#39;s get method to inject a call to a</span>
<span class="sd">            method to set the state on a remote device.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HasTraits</span><span class="p">)</span>

        <span class="c1"># If this is Device.settings instead of Device.state, do simple Trait.set,</span>
        <span class="c1"># skipping any communicate with the device</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HasSettingsTraits</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Trait.set already implements a check for self.read_only, so we don&#39;t</span>
        <span class="c1"># do that here.</span>

        <span class="c1"># Make sure the (potentially remapped) value meets criteria defined by</span>
        <span class="c1"># this traitlet subclass</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Remap the resulting value to the remote value</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># First, look for a getter function or method that implements getting</span>
        <span class="c1"># the value from the device</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;setter&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;setter&#39;</span><span class="p">](</span><span class="n">obj</span><span class="o">.</span><span class="n">_device</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># If there isn&#39;t one, try calling the command_get() method in the Device instance.</span>
        <span class="c1"># Otherwise, raise an exception, because we don&#39;t know how to get the</span>
        <span class="c1"># value from the Device.</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># self.command is not None:</span>
            <span class="c1"># try:</span>
            <span class="c1"># The below should raise CommandNotImplementedError if no command</span>
            <span class="c1"># or setter has been defined</span>

            <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__setter__</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_device</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="c1"># except CommandNotImplementedError as e:</span>
            <span class="c1">#     raise DeviceStateError(</span>
            <span class="c1">#         &#39;no command or setter defined - cannot set state to device&#39;)</span>

        <span class="c1"># Apply the value to the traitlet, saving the cached value if necessary</span>
        <span class="n">rd_only</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">,</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">rd_only</span>

    <span class="k">def</span> <span class="nf">setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;setter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;getter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="bp">self</span>


<div class="viewcode-block" id="Int"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Int">[docs]</a><span class="k">class</span> <span class="nc">Int</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">CInt</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for an integer value, with type and bounds checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">        :param min: lower bound for the value</span>
<span class="sd">        :param max: upper bound for the value</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">doc_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">TraitMixIn</span><span class="o">.</span><span class="n">doc_attrs</span></div>


<span class="k">class</span> <span class="nc">CFLoatSteppedTraitlet</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">CFloat</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for a quantized floating point value, with type and bounds checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">        :param min: lower bound for the value</span>
<span class="sd">        :param max: upper bound for the value</span>
<span class="sd">        :param step: resolution of the floating point values                </span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CFLoatSteppedTraitlet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>


<div class="viewcode-block" id="Float"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Float">[docs]</a><span class="k">class</span> <span class="nc">Float</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">CFLoatSteppedTraitlet</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for a floating point value, with type and bounds checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">        :param min: lower bound for the value</span>
<span class="sd">        :param max: upper bound for the value        </span>
<span class="sd">    &#39;&#39;&#39;</span>    

    <span class="n">doc_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">TraitMixIn</span><span class="o">.</span><span class="n">doc_attrs</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Round to nearest increment of step</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Unicode"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Unicode">[docs]</a><span class="k">class</span> <span class="nc">Unicode</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">CUnicode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for a Unicode string value, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">    &#39;&#39;&#39;</span>    

    <span class="n">default_value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="Complex"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Complex">[docs]</a><span class="k">class</span> <span class="nc">Complex</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">CComplex</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for a complex numeric value, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">    &#39;&#39;&#39;</span>    </div>


<div class="viewcode-block" id="Bytes"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Bytes">[docs]</a><span class="k">class</span> <span class="nc">Bytes</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">CBytes</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for a byte string value, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">    &#39;&#39;&#39;</span>    </div>

<div class="viewcode-block" id="TCPAddress"><a class="viewcode-back" href="../../labbench.html#labbench.backends.TCPAddress">[docs]</a><span class="k">class</span> <span class="nc">TCPAddress</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">TCPAddress</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for a (address, port) TCP address tuple value, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">    &#39;&#39;&#39;</span>    </div>


<div class="viewcode-block" id="List"><a class="viewcode-back" href="../../labbench.html#labbench.backends.List">[docs]</a><span class="k">class</span> <span class="nc">List</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for a python list value, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">default_value</span> <span class="o">=</span> <span class="p">[]</span></div>


<span class="k">class</span> <span class="nc">EnumBytesTraitlet</span><span class="p">(</span><span class="n">traitlets</span><span class="o">.</span><span class="n">CBytes</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for an enumerated list of valid byte string values, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[],</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must define at least one enum value&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">case_sensitive</span>
        <span class="k">if</span> <span class="n">case_sensitive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span> <span class="o">=</span> <span class="s1">&#39;castable to &#39;</span> <span class="o">+</span> \
                         <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">])</span> <span class="o">+</span> \
                         <span class="s1">&#39; (case insensitive)&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">case_sensitive</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">EnumBytesTraitlet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_sensitive</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">devalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="CaselessBytesEnum"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CaselessBytesEnum">[docs]</a><span class="k">class</span> <span class="nc">CaselessBytesEnum</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">EnumBytesTraitlet</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for an enumerated list of valid case-insensitive byte string values, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">        :param values: An iterable of valid byte strings to accept</span>
<span class="sd">        :param case_sensitive: Whether to be case_sensitive</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">doc_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="s1">&#39;case_sensitive&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">TraitMixIn</span><span class="o">.</span><span class="n">doc_attrs</span></div>


<div class="viewcode-block" id="CaselessStrEnum"><a class="viewcode-back" href="../../labbench.html#labbench.backends.CaselessStrEnum">[docs]</a><span class="k">class</span> <span class="nc">CaselessStrEnum</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">CaselessStrEnum</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for an enumerated list of valid case-insensitive unicode string values, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">        :param values: An iterable of valid unicode strings to accept</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">doc_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">TraitMixIn</span><span class="o">.</span><span class="n">doc_attrs</span></div>


<div class="viewcode-block" id="Dict"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Dict">[docs]</a><span class="k">class</span> <span class="nc">Dict</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">Dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for a python dict value, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">    &#39;&#39;&#39;</span></div>


<span class="c1"># class BoolTraitlet(traitlets.CBool):</span>
    <span class="c1"># def __init__(self, trues=[True], falses=[False], **kws):</span>
    <span class="c1">#     self._trues = [v.upper() if isinstance(v, str) else v for v in trues]</span>
    <span class="c1">#     self._falses = [v.upper() if isinstance(v, str) else v for v in falses]</span>
    <span class="c1">#     super(BoolTraitlet, self).__init__(**kws)</span>
    <span class="c1">#</span>
    <span class="c1"># def validate(self, obj, value):</span>
    <span class="c1">#     if isinstance(value, str):</span>
    <span class="c1">#         value = value.upper()</span>
    <span class="c1">#     if value in self._trues:</span>
    <span class="c1">#         return True</span>
    <span class="c1">#     elif value in self._falses:</span>
    <span class="c1">#         return False</span>
    <span class="c1">#     elif not isinstance(value, numbers.Number):</span>
    <span class="c1">#         raise ValueError(</span>
    <span class="c1">#             &#39;Need a boolean or numeric value to convert to integer, but given {} instead&#39; \</span>
    <span class="c1">#                 .format(repr(value)))</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         return bool(value)</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         self.error(obj, value)</span>
    <span class="c1">#</span>
    <span class="c1"># # Convert any castable value</span>
    <span class="c1"># # to the first entry in self._trues or self._falses</span>
    <span class="c1"># def devalidate(self, obj, value):</span>
    <span class="c1">#     if self.validate(obj, value):</span>
    <span class="c1">#         return self._trues[0]</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         return self._falses[0]</span>
    <span class="c1">#</span>
    <span class="c1"># default_value = False</span>


<div class="viewcode-block" id="Bool"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Bool">[docs]</a><span class="k">class</span> <span class="nc">Bool</span><span class="p">(</span><span class="n">TraitMixIn</span><span class="p">,</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">CBool</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Trait for a python boolean, with type checking.</span>

<span class="sd">        :param default_value: initial value (in `settings` only, not `state`)</span>
<span class="sd">        :param allow_none: whether to allow pythonic `None` to represent a null value</span>
<span class="sd">        :param read_only: True if this should not accept a set (write) operation</span>
<span class="sd">        :param write_only: True if this should not accept a get (read) operation (in `state` only, not `settings`)</span>
<span class="sd">        :param cache: True if this should only read from the device once, then return that value in future calls (in `state` only, not `settings`)</span>
<span class="sd">        :param getter: Function or other callable (no arguments) that retrieves the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param setter: Function or other callable (one `value` argument) that sets the value from the remote device, or None (in `state` only, not `settings`)</span>
<span class="sd">        :param remap: A dictionary {python_value: device_representation} to use as a look-up table that transforms python representation into the format expected by a device</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">default_value</span> <span class="o">=</span> <span class="kc">False</span></div>


<span class="k">class</span> <span class="nc">DisconnectedBackend</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; &quot;Null Backend&quot; implementation to raises an exception with discriptive</span>
<span class="sd">        messages on attempts to use a backend before a Device is connected.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dev</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; dev may be a class or an object for error feedback</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span> <span class="o">=</span> <span class="n">dev</span>

    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span>
                <span class="s1">&#39;need to connect first to access backend.</span><span class="si">{key}</span><span class="s1"> in </span><span class="si">{clsname}</span><span class="s1"> instance (resource=</span><span class="si">{resource}</span><span class="s1">)&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">clsname</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__dev__</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;DisconnectedBackend()&#39;</span>


<span class="k">class</span> <span class="nc">DeviceLogAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">LoggerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This example adapter expects the passed in dict-like object to have a</span>
<span class="sd">    &#39;connid&#39; key, whose value in brackets is prepended to the log message.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">),</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">to_name</span><span class="p">,</span> <span class="n">from_func</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; TODO: This looks like it duplicates functools.wrap - switch to</span>
<span class="sd">        functools.wrap?</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">to_func</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">to_name</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__wrapped__</span><span class="p">[</span><span class="n">to_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_func</span>
    <span class="n">from_func</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">to_func</span><span class="o">.</span><span class="vm">__doc__</span>
    <span class="n">from_func</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">to_func</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">to_name</span><span class="p">,</span> <span class="n">from_func</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">trace_methods</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">until_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Look for a method called `name` in cls and all of its parent classes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_method</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">this_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">this_method</span> <span class="o">!=</span> <span class="n">last_method</span><span class="p">:</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_method</span><span class="p">)</span>
            <span class="n">last_method</span> <span class="o">=</span> <span class="n">this_method</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">until_cls</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">methods</span>


<span class="k">def</span> <span class="nf">trim</span><span class="p">(</span><span class="n">docstring</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">docstring</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Convert tabs to spaces (following the normal Python rules)</span>
    <span class="c1"># and split into a list of lines:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="c1"># Determine minimum indentation (first line doesn&#39;t count):</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">stripped</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stripped</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">stripped</span><span class="p">))</span>
    <span class="c1"># Remove indentation (first line is special):</span>
    <span class="n">trimmed</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">indent</span> <span class="o">&lt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">trimmed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">indent</span><span class="p">:]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    <span class="c1"># Strip off trailing and leading blank lines:</span>
    <span class="k">while</span> <span class="n">trimmed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trimmed</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">trimmed</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">trimmed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">trimmed</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Return a single string:</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trimmed</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DeviceMetaclass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Dynamically adjust the class documentation strings to include the traits</span>
<span class="sd">        defined in its settings. This way we get the documentation without</span>
<span class="sd">        error-prone copy and paste.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">autocomplete_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kws</span><span class="p">):</span>
            <span class="n">all_</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kws</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="n">kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kws</span><span class="p">,</span> <span class="vm">__func__</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;lambda </span><span class="si">{a}</span><span class="s2">,*args,**kws: __func__(</span><span class="si">{a}</span><span class="s2">,*args,**kws)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">a</span><span class="o">=</span><span class="n">all_</span><span class="p">)</span>
            <span class="n">wrapper</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">kws</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;__doc__&#39;</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">,</span> <span class="s1">&#39;__qualname__&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">wrapper</span>
        
        <span class="k">def</span> <span class="nf">autosubclass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">expected_parent_cls</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; Make cls.state and cls.settings subclasses of the parent class</span>
<span class="sd">                state or settings, if they are not defined as subclasses.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">member_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">member_cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>\
               <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member_cls</span><span class="p">,</span> <span class="n">expected_parent_cls</span><span class="p">):</span>
                   <span class="n">parent_member_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">name</span><span class="p">)</span>
                   <span class="n">new_member_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">member_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                         <span class="p">(</span><span class="n">parent_member_cls</span><span class="p">,),</span>
                                         <span class="nb">dict</span><span class="p">(</span><span class="n">member_cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span>
                   <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_member_cls</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DeviceMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

        <span class="c1"># Automatically make cls.state and cls.settings subclasses of the</span>
        <span class="c1"># parent class state or settings, if they are not defined as subclasses</span>
        <span class="n">autosubclass</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="n">HasStateTraits</span><span class="p">)</span>
        <span class="n">autosubclass</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">,</span> <span class="n">HasSettingsTraits</span><span class="p">)</span>

        <span class="n">traits</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">class_traits</span><span class="p">()</span>

        <span class="c1"># Skip read-only traits</span>
        <span class="n">traits</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">read_only</span><span class="p">])</span>

        <span class="n">kws</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="n">traits</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default_value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
                <span class="n">kws</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">default_value</span>

        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span>
        <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="n">autocomplete_wrapper</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">],</span> <span class="n">kws</span><span class="p">)</span>
        <span class="c1">#bind_wrapper_to_class(cls, &#39;__init__&#39;)</span>
        <span class="kn">import</span> <span class="nn">functools</span>
        <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span> <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">trim</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ttype</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">trait</span><span class="o">.</span><span class="n">info_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">:param `</span><span class="si">{type}</span><span class="s1">` </span><span class="si">{name}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{info}</span><span class="s1">&#39;</span>\
                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="n">trait</span><span class="o">.</span><span class="n">help</span><span class="p">,</span>
                           <span class="nb">type</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span>
                           <span class="n">info</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">+=</span> <span class="n">line</span>
            <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">+=</span> <span class="n">line</span>


<div class="viewcode-block" id="Device"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Device">[docs]</a><span class="k">class</span> <span class="nc">Device</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">DeviceMetaclass</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;`Device` is the base class common to all labbench</span>
<span class="sd">        drivers. Inherit it to implement a backend, or a specialized type of</span>
<span class="sd">        driver.</span>

<span class="sd">        Drivers that subclass `Device` get</span>

<span class="sd">        * device connection management via context management (the `with` statement)</span>
<span class="sd">        * test state management for easy test logging and extension to UI</span>
<span class="sd">        * a degree automatic stylistic consistency between drivers</span>

<span class="sd">        :param resource: resource identifier, with type and format determined by backend (see specific subclasses for details)</span>
<span class="sd">        :param **local_states: set the local state for each supplied state key and value</span>

<span class="sd">        .. note::</span>
<span class="sd">            Use `Device` by subclassing it only if you are</span>
<span class="sd">            implementing a driver that needs a new type of backend.</span>

<span class="sd">            Several types of backends have already been implemented</span>
<span class="sd">            as part of labbench:</span>

<span class="sd">                * VISADevice exposes a pyvisa backend for VISA Instruments</span>
<span class="sd">                * CommandLineWrapper exposes a threaded pipes backend for command line tools</span>
<span class="sd">                * Serial exposes a pyserial backend for serial port communication</span>
<span class="sd">                * DotNetDevice exposes a pythonnet for wrapping dotnet libraries</span>

<span class="sd">            (and others). If you are implementing a driver that uses one of</span>
<span class="sd">            these backends, inherit from the corresponding class above, not</span>
<span class="sd">            `Device`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Device.settings"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Device.settings">[docs]</a>    <span class="k">class</span> <span class="nc">settings</span><span class="p">(</span><span class="n">HasSettingsTraits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Container for settings traits in a Device.</span>

<span class="sd">            These settings</span>
<span class="sd">            are stored only on the host; setting or getting these values do not</span>
<span class="sd">            trigger live updates (or any communication) with the device. These</span>
<span class="sd">            define connection addressing information, communication settings,</span>
<span class="sd">            and options that only apply to implementing python support for the</span>
<span class="sd">            device.</span>

<span class="sd">            The device uses this container to define the keyword options supported</span>
<span class="sd">            by its __init__ function. These are applied when you instantiate the device.</span>
<span class="sd">            After you instantiate the device, you can still change the setting with::</span>

<span class="sd">                Device.settings.resource = &#39;insert-your-address-string-here&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">resource</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Addressing information needed to make a connection to a device. Type and format are determined by the subclass implementation&#39;</span><span class="p">)</span>
        <span class="n">concurrency_support</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether this backend supports threading&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Device.state"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Device.state">[docs]</a>    <span class="k">class</span> <span class="nc">state</span><span class="p">(</span><span class="n">HasStateTraits</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Container for state traits in a Device. Getting or setting state traits</span>
<span class="sd">            triggers live updates: communication with the device to get or set the</span>
<span class="sd">            value on the Device. Therefore, getting or setting state traits</span>
<span class="sd">            needs the device to be connected.</span>

<span class="sd">            To set a state value inside the device, use normal python assigment::</span>

<span class="sd">                device.state.parameter = value</span>
<span class="sd">                </span>
<span class="sd">            To get a state value from the device, you can also use it as a normal python variable::</span>
<span class="sd">            </span>
<span class="sd">                variable = device.state.parameter + 1</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">connected</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s1">&#39;whether the :class:`Device` instance is connected&#39;</span><span class="p">)</span></div>

    <span class="n">backend</span> <span class="o">=</span> <span class="n">DisconnectedBackend</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39; .. attribute::state is the backend that controls communication with the device.</span>
<span class="sd">        it is to be set in `connect` and `disconnect` by the subclass that implements the backend.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Backend classes may optionally overload these, and do not need to call the parents</span>
    <span class="c1"># defined here</span>
<div class="viewcode-block" id="Device.connect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Device.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Backend implementations overload this to open a backend</span>
<span class="sd">            connection to the resource.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Device.disconnect"><a class="viewcode-back" href="../../labbench.html#labbench.backends.Device.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Backend implementations must overload this to disconnect an</span>
<span class="sd">            existing connection to the resource encapsulated in the object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">DisconnectedBackend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span></div>

<span class="c1">#    def command_get(self, command, trait):</span>
<span class="c1">#        &#39;&#39;&#39; Read a setting from a remote instrument, keyed on a command string.</span>
<span class="c1">#            Implement this for message-based protocols, like VISA SCPI or some serial devices.</span>
<span class="c1">#</span>
<span class="c1">#            :param str command: the command message to apply to `value`</span>
<span class="c1">#            :param trait: the state descriptor or traitlet</span>
<span class="c1">#            :returns: the value retrieved from the instrument</span>
<span class="c1">#        &#39;&#39;&#39;</span>
<span class="c1">#        raise CommandNotImplementedError(</span>
<span class="c1">#            &#39;state &quot;{attr}&quot; is defined but not implemented! implement {cls}.command_set, or implement a setter for {cls}.state.{attr}&#39;</span>
<span class="c1">#            .format(cls=type(self).__name__, attr=trait))</span>
<span class="c1">#</span>
<span class="c1">#    def command_set(self, command, trait, value):</span>
<span class="c1">#        &#39;&#39;&#39; Apply an instrument setting to the instrument, keyed on a command string.</span>
<span class="c1">#            Implement this for message-based protocols, like VISA SCPI or some serial devices.</span>
<span class="c1">#</span>
<span class="c1">#            :param str command: the command message to apply to `value`</span>
<span class="c1">#            :param trait: the state descriptor or traitlet</span>
<span class="c1">#            :param value: the value to set</span>
<span class="c1">#        &#39;&#39;&#39;</span>
<span class="c1">#        raise CommandNotImplementedError(</span>
<span class="c1">#            &#39;state &quot;{attr}&quot; is defined but not implemented! implement {cls}.command_get, or implement a getter for {cls}.state.{attr}&#39;</span>
<span class="c1">#            .format(cls=type(self).__name__, attr=trait))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wrapped__</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Instantiate state, and observe connection state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__imports__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">DisconnectedBackend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Set local settings according to local_states</span>
        <span class="n">all_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;resource&#39;</span> <span class="ow">and</span> <span class="n">resource</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_settings</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;tried to set initialize setting </span><span class="si">{k}</span><span class="s1">, but it is not defined in </span><span class="si">{clsname}</span><span class="s1">.settings&#39;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">clsname</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;resource=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">))]</span> <span class="o">+</span> \
                        <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                         <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">DeviceLogAdapter</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>

        <span class="c1"># Instantiate state now. It needs to be here, after settings are fully</span>
        <span class="c1"># instantiated, in case state implementation depends on settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connect_wrapper__</span><span class="p">)</span>
        <span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__disconnect_wrapper__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__connect_wrapper__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; A wrapper for the connect() method. It works through the</span>
<span class="sd">            method resolution order of self.__class__, starting from</span>
<span class="sd">            labbench.Device, and calls its connect() method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> already connected&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">connect</span> <span class="ow">in</span> <span class="n">trace_methods</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="n">Device</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Force an update to self.state.connected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span>

    <span class="k">def</span> <span class="nf">__disconnect_wrapper__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; A wrapper for the disconnect() method that runs</span>
<span class="sd">            cleanup() before calling disconnect(). disconnect()</span>
<span class="sd">            will still be called if there is an exception in cleanup().</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Try to run cleanup(), but make sure to run</span>
        <span class="c1"># disconnect() even if it fails</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> already disconnected&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="n">methods</span> <span class="o">=</span> <span class="n">trace_methods</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="n">Device</span><span class="p">)</span>

        <span class="n">all_ex</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">disconnect</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">all_ex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>

        <span class="c1"># Print tracebacks for any suppressed exceptions</span>
        <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">all_ex</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># If ThreadEndedByMaster was raised, assume the error handling in</span>
            <span class="c1"># util.concurrently will print the error message</span>
            <span class="k">if</span> <span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">ThreadEndedByMaster</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">walk_tb</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="o">*</span><span class="n">ex</span><span class="p">,</span> <span class="n">limit</span><span class="o">=-</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;(Exception suppressed to continue disconnect)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">connected</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> disconnected&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__imports__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                               <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">resource</span><span class="p">))</span>

    <span class="nd">@state</span><span class="o">.</span><span class="n">connected</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="n">DisconnectedBackend</span><span class="p">)</span>

    <span class="fm">__str__</span> <span class="o">=</span> <span class="fm">__repr__</span></div>


<div class="viewcode-block" id="list_devices"><a class="viewcode-back" href="../../labbench.html#labbench.backends.list_devices">[docs]</a><span class="k">def</span> <span class="nf">list_devices</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Look for Device instances, and their names, in the calling</span>
<span class="sd">        code context (depth == 1) or its callers (if depth in (2,3,...)).</span>
<span class="sd">        Checks locals() in that context first.</span>
<span class="sd">        If no Device instances are found there, search the first</span>
<span class="sd">        argument of the first function argument, in case this is</span>
<span class="sd">        a method in a class.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">getouterframes</span><span class="p">,</span> <span class="n">currentframe</span>
    <span class="kn">from</span> <span class="nn">sortedcontainers</span> <span class="k">import</span> <span class="n">sorteddict</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">getouterframes</span><span class="p">(</span><span class="n">currentframe</span><span class="p">())[</span><span class="n">depth</span><span class="p">]</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sorteddict</span><span class="o">.</span><span class="n">SortedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Device</span><span class="p">):</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># If the context is a function, look in its first argument,</span>
    <span class="c1"># in case it is a method. Search its class instance.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Device</span><span class="p">):</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">ret</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench v0.20</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
<hr \>
<section class="footer">
<br><a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#privpolicy">Privacy Policy</a> | <a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#secnot">Security Notice</a> | <a href="http://www.nist.gov/public_affairs/privacy.cfm#accesstate">Accessibility Statement</a>
<br><em>United States government work, not subject to copyright in the United States</em>
</section>

  </body>
</html>