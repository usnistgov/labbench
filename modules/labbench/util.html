<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>labbench.util &#8212; labbench vgit</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
<header class="nist-header">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>NIST Pages Template</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="labbench vgit">
  <link rel="canonical" href="../../">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Google Analytics -->
  <!--<script type="text/javascript" id="_fed_an_js_tag" src="http://www.nist.gov/js/federated-analytics.all.min.js?agency=NIST&subagency=mml&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script> -->
  <!-- DAP Analytics -->
  <script type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&subagefncy=NIST&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../..//static/NISTStyle.css">
  <link rel="stylesheet" href="../..//static/NISTPages.css">

  <h1>
    <a class="nist-logo" target="_blank" href="http://www.nist.gov/" title="Go to nist.gov">National Institute of Standards and Technology</a>
  </h1>
  <div class="nist-links">
    <a class="nist-links-button" target="_blank" href="http://www.nist.gov">NIST Website</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="http://www.nist.gov/public_affairs/nandyou.cfm">About NIST</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="https://github.com/usnistgov">usnistgov on GitHub</a>
  </div>
  
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</header>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench vgit</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">labbench.util</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for labbench.util</h1><div class="highlight"><pre>
<span></span><span class="c1"># This software was developed by employees of the National Institute of</span>
<span class="c1"># Standards and Technology (NIST), an agency of the Federal Government.</span>
<span class="c1"># Pursuant to title 17 United States Code Section 105, works of NIST employees</span>
<span class="c1"># are not subject to copyright protection in the United States and are</span>
<span class="c1"># considered to be in the public domain. Permission to freely use, copy,</span>
<span class="c1"># modify, and distribute this software and its documentation without fee is</span>
<span class="c1"># hereby granted, provided that this notice and disclaimer of warranty appears</span>
<span class="c1"># in all copies.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &#39;AS IS&#39; WITHOUT ANY WARRANTY OF ANY KIND, EITHER</span>
<span class="c1"># EXPRESSED, IMPLIED, OR STATUTORY, INCLUDING, BUT NOT LIMITED TO, ANY WARRANTY</span>
<span class="c1"># THAT THE SOFTWARE WILL CONFORM TO SPECIFICATIONS, ANY IMPLIED WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND FREEDOM FROM</span>
<span class="c1"># INFRINGEMENT, AND ANY WARRANTY THAT THE DOCUMENTATION WILL CONFORM TO THE</span>
<span class="c1"># SOFTWARE, OR ANY WARRANTY THAT THE SOFTWARE WILL BE ERROR FREE. IN NO EVENT</span>
<span class="c1"># SHALL NIST BE LIABLE FOR ANY DAMAGES, INCLUDING, BUT NOT LIMITED TO, DIRECT,</span>
<span class="c1"># INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES, ARISING OUT OF, RESULTING FROM,</span>
<span class="c1"># OR IN ANY WAY CONNECTED WITH THIS SOFTWARE, WHETHER OR NOT BASED UPON</span>
<span class="c1"># WARRANTY, CONTRACT, TORT, OR OTHERWISE, WHETHER OR NOT INJURY WAS SUSTAINED</span>
<span class="c1"># BY PERSONS OR PROPERTY OR OTHERWISE, AND WHETHER OR NOT LOSS WAS SUSTAINED</span>
<span class="c1"># FROM, OR AROSE OUT OF THE RESULTS OF, OR USE OF, THE SOFTWARE OR SERVICES</span>
<span class="c1"># PROVIDED HEREUNDER. Distributions of NIST software should also include</span>
<span class="c1"># copyright and licensing statements of any third-party software that are</span>
<span class="c1"># legally bundled with the code in compliance with the conditions of those</span>
<span class="c1"># licenses.</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>  <span class="c1"># &quot;misc&quot;</span>
    <span class="s2">&quot;ConfigStore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hash_caller&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kill_by_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;show_messages&quot;</span><span class="p">,</span>
    <span class="s2">&quot;logger&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LabbenchDeprecationWarning&quot;</span><span class="p">,</span>
    <span class="s2">&quot;import_t0&quot;</span><span class="p">,</span>
    <span class="c1"># concurrency and sequencing</span>
    <span class="s2">&quot;concurrently&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sequentially&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Call&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ConcurrentException&quot;</span><span class="p">,</span>
    <span class="s2">&quot;check_hanging_thread&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ThreadSandbox&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ThreadEndedByMaster&quot;</span><span class="p">,</span>
    <span class="c1"># timing and flow management</span>
    <span class="s2">&quot;retry&quot;</span><span class="p">,</span>
    <span class="s2">&quot;until_timeout&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sleep&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stopwatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timeout_iter&quot;</span><span class="p">,</span>
    <span class="c1"># wrapper helpers</span>
    <span class="s2">&quot;copy_func&quot;</span><span class="p">,</span>
    <span class="c1"># traceback scrubbing</span>
    <span class="s2">&quot;hide_in_traceback&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_force_full_traceback&quot;</span><span class="p">,</span>
    <span class="c1"># helper objects</span>
    <span class="s2">&quot;Ownable&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">_GeneratorContextManager</span><span class="p">,</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">ThreadError</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">simplefilter</span>

<span class="kn">import</span> <span class="nn">psutil</span>

<span class="n">import_t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">LoggerAdapter</span><span class="p">(</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;labbench&quot;</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;labbench&quot;</span>
    <span class="p">),</span>  <span class="c1"># description of origin within labbench (for screen logs only)</span>
<span class="p">)</span>


<span class="c1"># show deprecation warnings only once</span>
<div class="viewcode-block" id="LabbenchDeprecationWarning"><a class="viewcode-back" href="../../labbench.html#labbench.LabbenchDeprecationWarning">[docs]</a><span class="k">class</span> <span class="nc">LabbenchDeprecationWarning</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;once&quot;</span><span class="p">,</span> <span class="n">LabbenchDeprecationWarning</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show_messages</span><span class="p">(</span><span class="n">minimum_level</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;filters logging messages displayed to the console by importance</span>

<span class="sd">    Arguments:</span>
<span class="sd">        minimum_level: &#39;debug&#39;, &#39;warning&#39;, &#39;error&#39;, or None (to disable all output)</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">logging</span>

    <span class="n">err_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
        <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="kc">False</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">minimum_level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">err_map</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">minimum_level</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;message level must be a flag </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">err_map</span><span class="p">)</span><span class="si">}</span><span class="s2"> or an integer, not </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">minimum_level</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">level</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">err_map</span><span class="p">[</span><span class="n">minimum_level</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">minimum_level</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">minimum_level</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="c1"># Clear out any stale handlers</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="s2">&quot;_screen_handler&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">_screen_handler</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">_screen_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">_screen_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    <span class="c1"># - %(pathname)s:%(lineno)d&#39;</span>

    <span class="k">if</span> <span class="n">colors</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">coloredlogs</span> <span class="kn">import</span> <span class="n">DEFAULT_FIELD_STYLES</span><span class="p">,</span> <span class="n">ColoredFormatter</span>

        <span class="n">log_fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{levelname:^7s}</span><span class="s2"> </span><span class="si">{asctime}</span><span class="s2">.</span><span class="si">{msecs:03.0f}</span><span class="s2"> â€¢ </span><span class="si">{label}</span><span class="s2">: </span><span class="si">{message}</span><span class="s2">&quot;</span>
        <span class="n">styles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">DEFAULT_FIELD_STYLES</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">ColoredFormatter</span><span class="p">(</span><span class="n">log_fmt</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="n">field_styles</span><span class="o">=</span><span class="n">styles</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{levelname:^7s}</span><span class="s2"> </span><span class="si">{asctime}</span><span class="s2">.</span><span class="si">{msecs:03.0f}</span><span class="s2"> â€¢ </span><span class="si">{label}</span><span class="s2">: </span><span class="si">{message}</span><span class="s2">&quot;</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">log_fmt</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">_screen_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">_screen_handler</span><span class="p">)</span>


<span class="n">show_messages</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_inject_logger_metadata</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">object</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
        <span class="n">origin</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
        <span class="n">owned_name</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">_owned_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;owned_name&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;owned_name&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">+</span> <span class="s2">&quot;(...)&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span>

    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">callable_logger</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__self__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">Ownable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="n">_logger</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">logger</span>


<div class="viewcode-block" id="Ownable"><a class="viewcode-back" href="../../labbench.html#labbench.Ownable">[docs]</a><span class="k">class</span> <span class="nc">Ownable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Subclass to pull in name from an owning class.&quot;&quot;&quot;</span>

    <span class="vm">__objclass__</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_owned_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">LoggerAdapter</span><span class="p">(</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="n">_inject_logger_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__objclass__</span> <span class="o">=</span> <span class="n">owner_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">owner_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__owner_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;called on instantiation of the owner (again for its parent owner)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">owner</span><span class="o">.</span><span class="n">_owned_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_owned_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_owned_name</span> <span class="o">=</span> <span class="n">owner</span><span class="o">.</span><span class="n">_owned_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">_inject_logger_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__owner_subclass__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner_cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called after the owner class is instantiated; returns an object to be used in the Rack namespace&quot;&quot;&quot;</span>
        <span class="c1"># TODO: revisit whether there should be any assignment of _owned_name here</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owned_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_owned_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__objclass__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">ownercls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__objclass__</span>

            <span class="n">typename</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">ownedname</span> <span class="o">=</span> <span class="n">ownercls</span><span class="o">.</span><span class="vm">__qualname__</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s2"> object at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="si">}</span><span class="s2"> bound to </span><span class="si">{</span><span class="n">ownedname</span><span class="si">}</span><span class="s2"> class at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">ownercls</span><span class="p">))</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owned_name</span> <span class="ow">or</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConcurrentException"><a class="viewcode-back" href="../../labbench.html#labbench.ConcurrentException">[docs]</a><span class="k">class</span> <span class="nc">ConcurrentException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised on concurrency errors in `labbench.concurrently`&quot;&quot;&quot;</span>

    <span class="n">thread_exceptions</span> <span class="o">=</span> <span class="p">[]</span></div>


<span class="k">class</span> <span class="nc">OwnerThreadException</span><span class="p">(</span><span class="n">ThreadError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised to encapsulate a thread raised by the owning thread during calls to `labbench.concurrently`&quot;&quot;&quot;</span>


<div class="viewcode-block" id="ThreadEndedByMaster"><a class="viewcode-back" href="../../labbench.html#labbench.ThreadEndedByMaster">[docs]</a><span class="k">class</span> <span class="nc">ThreadEndedByMaster</span><span class="p">(</span><span class="n">ThreadError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised in a thread to indicate the owning thread requested termination&quot;&quot;&quot;</span></div>


<span class="n">concurrency_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stop_request_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

<span class="n">sys</span><span class="o">.</span><span class="n">_debug_tb</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">TRACEBACK_HIDE_TAG</span> <span class="o">=</span> <span class="s2">&quot;ðŸ¦™ hide from traceback ðŸ¦™&quot;</span>


<span class="k">def</span> <span class="nf">hide_in_traceback</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">adjust</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__code__</span>

        <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="vm">__code__</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">co_consts</span><span class="o">=</span><span class="n">code</span><span class="o">.</span><span class="n">co_consts</span> <span class="o">+</span> <span class="p">(</span><span class="n">TRACEBACK_HIDE_TAG</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># python &lt; 3.8</span>
            <span class="n">f</span><span class="o">.</span><span class="vm">__code__</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">(</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_kwonlyargcount</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_consts</span> <span class="o">+</span> <span class="p">(</span><span class="n">TRACEBACK_HIDE_TAG</span><span class="p">,),</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
                <span class="n">code</span><span class="o">.</span><span class="n">co_cellvars</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> is not callable&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__code__&quot;</span><span class="p">):</span>
        <span class="n">adjust</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span> <span class="s2">&quot;__code__&quot;</span><span class="p">):</span>
        <span class="n">adjust</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">func</span>


<span class="k">def</span> <span class="nf">_force_full_traceback</span><span class="p">(</span><span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">_debug_tb</span> <span class="o">=</span> <span class="n">force</span>


<span class="k">class</span> <span class="nc">_filtered_exc_info</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a monkeypatch for sys.exc_info that removes functions from tracebacks</span>
<span class="sd">    that are tagged with TRACEBACK_HIDE_TAG</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lb_wrapped</span> <span class="o">=</span> <span class="n">wrapped</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">etype</span><span class="p">,</span> <span class="n">evalue</span><span class="p">,</span> <span class="n">start_tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lb_wrapped</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">_debug_tb</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">etype</span><span class="p">,</span> <span class="n">evalue</span><span class="p">,</span> <span class="n">start_tb</span>

            <span class="n">tb</span> <span class="o">=</span> <span class="n">prev_tb</span> <span class="o">=</span> <span class="n">start_tb</span>

            <span class="c1"># step through the stack traces</span>
            <span class="k">while</span> <span class="n">tb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">TRACEBACK_HIDE_TAG</span> <span class="ow">in</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_consts</span><span class="p">:</span>
                    <span class="c1"># when the tag is present, change the previous tb_next to skip this tb</span>
                    <span class="k">if</span> <span class="n">tb</span> <span class="ow">is</span> <span class="n">start_tb</span><span class="p">:</span>
                        <span class="n">start_tb</span> <span class="o">=</span> <span class="n">start_tb</span><span class="o">.</span><span class="n">tb_next</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prev_tb</span><span class="o">.</span><span class="n">tb_next</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_next</span>

                <span class="c1"># on to the next traceback</span>
                <span class="n">prev_tb</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_next</span>

            <span class="k">return</span> <span class="n">etype</span><span class="p">,</span> <span class="n">evalue</span><span class="p">,</span> <span class="n">start_tb</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">raise</span>


<div class="viewcode-block" id="copy_func"><a class="viewcode-back" href="../../labbench.html#labbench.copy_func">[docs]</a><span class="k">def</span> <span class="nf">copy_func</span><span class="p">(</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">assigned</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;__qualname__&quot;</span><span class="p">,</span> <span class="s2">&quot;__doc__&quot;</span><span class="p">,</span> <span class="s2">&quot;__annotations__&quot;</span><span class="p">),</span>
    <span class="n">updated</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;__dict__&quot;</span><span class="p">,),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;returns a copy of func with specified attributes (following the inspect.wraps arguments).</span>

<span class="sd">    This is similar to wrapping `func` with `lambda *args, **kws: func(*args, **kws)`, except</span>
<span class="sd">    the returned callable contains a duplicate of the bytecode in `func`. The idea that the</span>
<span class="sd">    returned copy has fresh to __doc__, __signature__, etc., which can be changed without</span>
<span class="sd">    independently of `func`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span>
        <span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="p">,</span>
        <span class="n">func</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">,</span>
        <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="n">func</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">,</span>
        <span class="n">func</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">assigned</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">updated</span><span class="p">:</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new</span></div>


<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">,</span> <span class="s2">&quot;lb_wrapped&quot;</span><span class="p">):</span>
    <span class="c1"># monkeypatch sys.exc_info if it needs</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="n">_filtered_exc_info</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span>


<span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Drop-in replacement for time.sleep that raises ConcurrentException</span>
<span class="sd">    if another thread requests that all threads stop.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">global</span> <span class="n">stop_request_event</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Raise ConcurrentException if the stop_request_event is set</span>
        <span class="k">if</span> <span class="n">stop_request_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">tick</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ThreadEndedByMaster</span>

        <span class="n">remaining</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>

        <span class="c1"># Return normally if the sleep finishes as requested</span>
        <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>


<div class="viewcode-block" id="check_hanging_thread"><a class="viewcode-back" href="../../labbench.html#labbench.check_hanging_thread">[docs]</a><span class="k">def</span> <span class="nf">check_hanging_thread</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raise ThreadEndedByMaster if the process has requested this</span>
<span class="sd">    thread to end.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span></div>


<span class="nd">@hide_in_traceback</span>
<span class="k">def</span> <span class="nf">retry</span><span class="p">(</span>
    <span class="n">exception_or_exceptions</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">backoff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">exception_func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This decorator causes the function call to repeat, suppressing specified exception(s), until a</span>
<span class="sd">    maximum number of retries has been attempted.</span>
<span class="sd">    - If the function raises the exception the specified number of times, the underlying exception is raised.</span>
<span class="sd">    - Otherwise, return the result of the function call.</span>

<span class="sd">    :example:</span>
<span class="sd">    The following retries the telnet connection 5 times on ConnectionRefusedError::</span>

<span class="sd">        import telnetlib</span>

<span class="sd">        # Retry a telnet connection 5 times if the telnet library raises ConnectionRefusedError</span>
<span class="sd">        @retry(ConnectionRefusedError, tries=5)</span>
<span class="sd">        def open(host, port):</span>
<span class="sd">            t = telnetlib.Telnet()</span>
<span class="sd">            t.open(host,port,5)</span>
<span class="sd">            return t</span>


<span class="sd">    Inspired by https://github.com/saltycrane/retry-decorator which is released</span>
<span class="sd">    under the BSD license.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        exception_or_exceptions: Exception (sub)class (or tuple of exception classes) to watch for</span>
<span class="sd">        tries: number of times to try before giving up</span>
<span class="sd">    :type tries: int</span>
<span class="sd">        delay: initial delay between retries in seconds</span>
<span class="sd">    :type delay: float</span>
<span class="sd">        backoff: backoff to multiply to the delay for each retry</span>
<span class="sd">    :type backoff: float</span>
<span class="sd">        exception_func: function to call on exception before the next retry</span>
<span class="sd">    :type exception_func: callable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nd">@hide_in_traceback</span>
        <span class="k">def</span> <span class="nf">do_retry</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">notified</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">active_delay</span> <span class="o">=</span> <span class="n">delay</span>
            <span class="k">for</span> <span class="n">retry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tries</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">exception_or_exceptions</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">notified</span><span class="p">:</span>
                        <span class="n">etype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__qualname__</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;caught &#39;</span><span class="si">{</span><span class="n">etype</span><span class="si">}</span><span class="s2">&#39; on first call to &#39;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; - repeating the call &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tries</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> more times or until no exception is raised&quot;</span>
                        <span class="p">)</span>

                        <span class="n">callable_logger</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                        <span class="n">notified</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="n">e</span>
                    <span class="n">exception_func</span><span class="p">()</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="n">active_delay</span><span class="p">)</span>
                    <span class="n">active_delay</span> <span class="o">=</span> <span class="n">active_delay</span> <span class="o">*</span> <span class="n">backoff</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>

            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">return</span> <span class="n">do_retry</span>

    <span class="k">return</span> <span class="n">decorator</span>


<span class="nd">@hide_in_traceback</span>
<span class="k">def</span> <span class="nf">until_timeout</span><span class="p">(</span>
    <span class="n">exception_or_exceptions</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">backoff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">exception_func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This decorator causes the function call to repeat, suppressing specified exception(s), until the</span>
<span class="sd">    specified timeout period has expired.</span>
<span class="sd">    - If the timeout expires, the underlying exception is raised.</span>
<span class="sd">    - Otherwise, return the result of the function call.</span>

<span class="sd">    Inspired by https://github.com/saltycrane/retry-decorator which is released</span>
<span class="sd">    under the BSD license.</span>


<span class="sd">    :example:</span>
<span class="sd">    The following retries the telnet connection for 5 seconds on ConnectionRefusedError::</span>

<span class="sd">        import telnetlib</span>

<span class="sd">        @until_timeout(ConnectionRefusedError, 5)</span>
<span class="sd">        def open(host, port):</span>
<span class="sd">            t = telnetlib.Telnet()</span>
<span class="sd">            t.open(host,port,5)</span>
<span class="sd">            return t</span>

<span class="sd">    Arguments:</span>
<span class="sd">        exception_or_exceptions: Exception (sub)class (or tuple of exception classes) to watch for</span>
<span class="sd">        timeout: time in seconds to continue calling the decorated function while suppressing exception_or_exceptions</span>
<span class="sd">    :type timeout: float</span>
<span class="sd">        delay: initial delay between retries in seconds</span>
<span class="sd">    :type delay: float</span>
<span class="sd">        backoff: backoff to multiply to the delay for each retry</span>
<span class="sd">    :type backoff: float</span>
<span class="sd">        exception_func: function to call on exception before the next retry</span>
<span class="sd">    :type exception_func: callable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nd">@hide_in_traceback</span>
        <span class="k">def</span> <span class="nf">do_retry</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">notified</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">active_delay</span> <span class="o">=</span> <span class="n">delay</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">exception_or_exceptions</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">notified</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">-</span> <span class="n">progress</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">etype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__qualname__</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;caught &#39;</span><span class="si">{</span><span class="n">etype</span><span class="si">}</span><span class="s2">&#39; in first call to &#39;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; - repeating calls for &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;another </span><span class="si">{</span><span class="n">timeout</span><span class="o">-</span><span class="n">progress</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">s, or until no exception is raised&quot;</span>
                        <span class="p">)</span>

                        <span class="n">callable_logger</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                        <span class="n">notified</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">ex</span> <span class="o">=</span> <span class="n">e</span>
                    <span class="n">exception_func</span><span class="p">()</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="n">active_delay</span><span class="p">)</span>
                    <span class="n">active_delay</span> <span class="o">=</span> <span class="n">active_delay</span> <span class="o">*</span> <span class="n">backoff</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>

            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">return</span> <span class="n">do_retry</span>

    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">def</span> <span class="nf">timeout_iter</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;sets a timer for `duration` seconds, yields time elapsed as long as timeout has not been reached&quot;&quot;&quot;</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">duration</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">elapsed</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>


<div class="viewcode-block" id="kill_by_name"><a class="viewcode-back" href="../../labbench.html#labbench.kill_by_name">[docs]</a><span class="k">def</span> <span class="nf">kill_by_name</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Kill one or more running processes by the name(s) of matching binaries.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        names: list of names of processes to kill</span>
<span class="sd">    :type names: str</span>

<span class="sd">    :example:</span>
<span class="sd">    &gt;&gt;&gt; # Kill any binaries called &#39;notepad.exe&#39; or &#39;notepad2.exe&#39;</span>
<span class="sd">    &gt;&gt;&gt; kill_by_name(&#39;notepad.exe&#39;, &#39;notepad2.exe&#39;)</span>

<span class="sd">    :Notes:</span>
<span class="sd">    Looks for a case-insensitive match against the Process.name() in the</span>
<span class="sd">    psutil library. Though psutil is cross-platform, the naming convention</span>
<span class="sd">    returned by name() is platform-dependent. In windows, for example, name()</span>
<span class="sd">    usually ends in &#39;.exe&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">pids</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;killing process </span><span class="si">{</span><span class="n">proc</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
            <span class="k">continue</span></div>


<div class="viewcode-block" id="hash_caller"><a class="viewcode-back" href="../../labbench.html#labbench.hash_caller">[docs]</a><span class="k">def</span> <span class="nf">hash_caller</span><span class="p">(</span><span class="n">call_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use introspection to return an SHA224 hex digest of the caller, which</span>
<span class="sd">    is almost certainly unique to the combination of the caller source code</span>
<span class="sd">    and the arguments passed it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">inspect</span>
    <span class="kn">import</span> <span class="nn">pickle</span>

    <span class="n">thisframe</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">thisframe</span><span class="p">)[</span><span class="n">call_depth</span><span class="p">]</span>
    <span class="n">arginfo</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargvalues</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1"># get the function object for a simple function</span>
    <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">function</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">function</span><span class="p">]</span>
        <span class="n">argnames</span> <span class="o">=</span> <span class="n">arginfo</span><span class="o">.</span><span class="n">args</span>

    <span class="c1"># get the function object for a method in a class</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arginfo</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># arginfo.args[0] == &#39;self&#39;:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">arginfo</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;failed to find function object by introspection&quot;</span><span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">frame</span><span class="o">.</span><span class="n">function</span><span class="p">)</span>
        <span class="n">argnames</span> <span class="o">=</span> <span class="n">arginfo</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># there weren&#39;t any arguments</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">argnames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arginfo</span><span class="o">.</span><span class="n">locals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">]</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha224</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">stopwatch</span><span class="p">(</span><span class="n">desc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Time a block of code using a with statement like this:</span>

<span class="sd">    &gt;&gt;&gt; with stopwatch(&#39;sleep statement&#39;):</span>
<span class="sd">    &gt;&gt;&gt;     time.sleep(2)</span>
<span class="sd">    sleep statement time elapsed 1.999s.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        desc: text for display that describes the event being timed</span>
<span class="sd">        threshold: only show timing if at least this much time (in s) elapsed</span>
<span class="sd">    :</span>
<span class="sd">    Returns:</span>
<span class="sd">        context manager</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> s elapsed&quot;</span>

            <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">exc_info</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; before exception </span><span class="si">{</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">Call</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrap a function to apply arguments for threaded calls to `concurrently`.</span>
<span class="sd">    This can be passed in directly by a user in order to provide arguments;</span>
<span class="sd">    otherwise, it will automatically be wrapped inside `concurrently` to</span>
<span class="sd">    keep track of some call metadata during execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`func` argument is not callable&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kws</span> <span class="o">=</span> <span class="n">kws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[(</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="n">qualname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__qualname__</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Call(</span><span class="si">{</span><span class="n">qualname</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="nd">@hide_in_traceback</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>

<div class="viewcode-block" id="Call.set_queue"><a class="viewcode-back" href="../../labbench.html#labbench.Call.set_queue">[docs]</a>    <span class="k">def</span> <span class="nf">set_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the queue object used to communicate between threads&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span></div>

<div class="viewcode-block" id="Call.wrap_list_to_dict"><a class="viewcode-back" href="../../labbench.html#labbench.Call.wrap_list_to_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">wrap_list_to_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name_func_pairs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;adjusts naming and wraps callables with Call&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># First, generate the list of callables</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">name_func_pairs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not find name of </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

                <span class="n">func</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;another callable is already named </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2"> - &quot;</span>
                        <span class="s2">&quot;pass as a keyword argument to specify a different name&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="n">ret</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="k">return</span> <span class="n">ret</span></div>


<span class="k">class</span> <span class="nc">MultipleContexts</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle opening multiple contexts in a single `with` block. This is</span>
<span class="sd">    a threadsafe implementation that accepts a handler function that may</span>
<span class="sd">    implement any desired any desired type of concurrency in entering</span>
<span class="sd">    each context.</span>

<span class="sd">    The handler is responsible for sequencing the calls that enter each</span>
<span class="sd">    context. In the event of an exception, `MultipleContexts` calls</span>
<span class="sd">    the __exit__ condition of each context that has already</span>
<span class="sd">    been entered.</span>

<span class="sd">    In the current implementation, __exit__ calls are made sequentially</span>
<span class="sd">    (not through call_handler), in the reversed order that each context</span>
<span class="sd">    __enter__ was called.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">call_handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="nb">dict</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">objs</span><span class="p">:</span> <span class="nb">list</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            call_handler: one of `sequentially_call` or `concurrently_call`</span>
<span class="sd">            params: a dictionary of operating parameters (see `concurrently`)</span>
<span class="sd">            objs: a list of contexts to be entered and dict-like objects to return</span>

<span class="sd">        Returns:</span>

<span class="sd">            context object for use in a `with` statement</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># enter = self.enter</span>
        <span class="c1"># def wrapped_enter(name, context):</span>
        <span class="c1">#     return enter(name, context)</span>
        <span class="c1"># wrapped_enter.__name__ = &#39;MultipleContexts_enter_&#39; + hex(id(self)+id(call_handler))</span>

        <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abort</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entered</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;__enter__&quot;</span>

        <span class="c1"># make up names for the __enter__ objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objs</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;enter_</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_handler</span> <span class="o">=</span> <span class="n">call_handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exc</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@hide_in_traceback</span>
    <span class="k">def</span> <span class="nf">enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        enter!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">:</span>
            <span class="c1"># proceed only if there have been no exceptions</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>  <span class="c1"># start of a context entry thread</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_entered</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>

    <span class="nd">@hide_in_traceback</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">Call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enter</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objs</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">stopwatch</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;entry into context for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">call_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">calls</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># exit any open contexts before raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

    <span class="nd">@hide_in_traceback</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">stopwatch</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - context exit&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_entered</span><span class="o">.</span><span class="n">keys</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entered</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

                    <span class="c1"># don&#39;t overwrite the original exception, if there was one</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

            <span class="n">contexts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">exc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">contexts</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entered</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">contexts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.__exit__ raised </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> in cleanup attempt after another &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;exception in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.__enter__&quot;</span>
                            <span class="p">)</span>

                            <span class="n">log_obj</span> <span class="o">=</span> <span class="n">callable_logger</span><span class="p">(</span><span class="n">contexts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">)</span>

                            <span class="n">log_obj</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">exc_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">ConcurrentException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;exceptions raised in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2"> contexts are printed inline&quot;</span>
            <span class="p">)</span>
            <span class="n">ex</span><span class="o">.</span><span class="n">thread_exceptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc</span>
            <span class="k">raise</span> <span class="n">ex</span>
        <span class="k">if</span> <span class="n">exc</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># sys.exc_info() may have been</span>
            <span class="c1"># changed by one of the exit methods</span>
            <span class="c1"># so provide explicit exception info</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">raise</span> <span class="n">exc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="n">RUNNERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s2">&quot;context&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s2">&quot;callable&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">DIR_DICT</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">isdictducktype</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">DIR_DICT</span><span class="p">)</span>


<span class="nd">@hide_in_traceback</span>
<span class="k">def</span> <span class="nf">enter_or_call</span><span class="p">(</span><span class="n">flexible_caller</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="n">kws</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract value traits from the keyword arguments flags, decide whether</span>
<span class="sd">    `objs` and `kws` should be treated as context managers or callables,</span>
<span class="sd">    and then either enter the contexts or call the callables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">objs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>

    <span class="c1"># Treat keyword arguments passed as callables should be left as callables;</span>
    <span class="c1"># otherwise, override the parameter</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">catch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traceback_delay</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge_inputs</span><span class="p">(</span><span class="n">dicts</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge nested returns and check for return data key conflicts in</span>
<span class="sd">        the callable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">:</span>
            <span class="n">common</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">which</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">common</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;attempting to merge results and dict arguments, but the key names (</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">) conflict in nested calls&quot;</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">conflicts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conflicts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;keys of conflict in nested return dictionary keys with &quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">merge_results</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">isdictducktype</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
                <span class="n">conflicts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">start_keys</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conflicts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">conflicts</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conflicts</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;conflicts in keys (</span><span class="si">{</span><span class="n">conflicts</span><span class="si">}</span><span class="s2">) when merging return dictionaries&quot;</span>
                    <span class="p">)</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

    <span class="c1"># Pull parameters from the passed keywords</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kws</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">kws</span><span class="p">[</span><span class="n">name</span><span class="p">]):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># come up with a gobbledigook name that is at least unique</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_back</span>
        <span class="n">params</span><span class="p">[</span>
            <span class="s2">&quot;name&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="si">}</span><span class="s2"> call 0x</span><span class="si">{</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="c1"># Combine the position and keyword arguments, and assign labels</span>
    <span class="n">allobjs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">kws</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">kws</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">allobjs</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">allobjs</span><span class="p">,</span> <span class="n">names</span>

    <span class="n">dicts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Make sure candidates are either (1) all context managers</span>
    <span class="c1"># or (2) all callables. Decide what type of operation to proceed with.</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
        <span class="c1"># pass through dictionary objects from nested calls</span>
        <span class="k">if</span> <span class="n">isdictducktype</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="n">dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidates</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="n">thisone</span> <span class="o">=</span> <span class="n">RUNNERS</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="nb">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_GeneratorContextManager</span><span class="p">)</span>
            <span class="p">),</span>  <span class="c1"># Is it callable?</span>
            <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__enter__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_GeneratorContextManager</span><span class="p">)</span>
            <span class="p">),</span>  <span class="c1"># Is it a context manager?</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">thisone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;each argument must be a callable and/or a context manager, &quot;</span>

            <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;but given </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;but given </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">runner</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">):</span>
            <span class="n">runner</span> <span class="o">=</span> <span class="n">thisone</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thisone</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;cannot mix context managers and callables&quot;</span><span class="p">)</span>

    <span class="c1"># Enforce uniqueness in the (callable or context manager) object</span>
    <span class="n">candidate_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">candidate_objs</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_objs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;each callable and context manager must be unique&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">runner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="n">runner</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;all objects supported both calling and context management - not sure which to run&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">runner</span> <span class="o">==</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dicts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;unexpected return value dictionary argument for context management </span><span class="si">{</span><span class="n">dicts</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">MultipleContexts</span><span class="p">(</span><span class="n">flexible_caller</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">candidates</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">merge_inputs</span><span class="p">(</span><span class="n">dicts</span><span class="p">,</span> <span class="n">candidates</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">flexible_caller</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">candidates</span><span class="p">)</span>

        <span class="n">start_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;flatten&quot;</span><span class="p">]:</span>
            <span class="n">merge_results</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>


<span class="nd">@hide_in_traceback</span>
<span class="k">def</span> <span class="nf">concurrently_call</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">name_func_pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">concurrency_count</span>

    <span class="k">def</span> <span class="nf">traceback_skip</span><span class="p">(</span><span class="n">exc_tuple</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Skip the first `count` traceback entries in</span>
<span class="sd">        an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">exc_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_next</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_next</span>
        <span class="k">return</span> <span class="n">exc_tuple</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">tb</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">check_thread_support</span><span class="p">(</span><span class="n">func_in</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup threading (concurrent execution only), including</span>
<span class="sd">        checks for whether a Device instance indicates it supports</span>
<span class="sd">        concurrent execution or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">func_in</span><span class="o">.</span><span class="n">func</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_in</span><span class="p">,</span> <span class="n">Call</span><span class="p">)</span> <span class="k">else</span> <span class="n">func_in</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__self__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">func</span><span class="o">.</span><span class="vm">__self__</span><span class="p">,</span> <span class="s2">&quot;concurrency&quot;</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">):</span>
            <span class="c1"># is this a Device that does not support concurrency?</span>
            <span class="k">raise</span> <span class="n">ConcurrentException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__self__</span><span class="si">}</span><span class="s2"> does not support concurrency&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func_in</span>

    <span class="n">stop_request_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">catch</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;catch&quot;</span><span class="p">]</span>
    <span class="n">traceback_delay</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;traceback_delay&quot;</span><span class="p">]</span>

    <span class="c1"># Setup calls then funcs</span>
    <span class="c1"># Set up mappings between wrappers, threads, and the function to call</span>
    <span class="n">wrappers</span> <span class="o">=</span> <span class="n">Call</span><span class="o">.</span><span class="n">wrap_list_to_dict</span><span class="p">(</span><span class="n">name_func_pairs</span><span class="p">)</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wrappers</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># Start threads with calls to each function</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">thread</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">threads</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">wrappers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set_queue</span><span class="p">(</span><span class="n">finished</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">concurrency_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># As each thread ends, collect the return value and any exceptions</span>
    <span class="n">tracebacks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parent_exception</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">called</span> <span class="o">=</span> <span class="n">finished</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">15</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">threads</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2"> threads are still running&quot;</span><span class="p">)</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">parent_exception</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">stop_request_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="n">called</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">called</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Below only happens when called is not none</span>
        <span class="k">if</span> <span class="n">parent_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">threads</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;raising </span><span class="si">{</span><span class="n">parent_exception</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> in main thread after child threads </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2"> return&quot;</span>
            <span class="p">)</span>

        <span class="c1"># if there was an exception that wasn&#39;t us ending the thread,</span>
        <span class="c1"># show messages</span>
        <span class="k">if</span> <span class="n">called</span><span class="o">.</span><span class="n">traceback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback_skip</span><span class="p">(</span><span class="n">called</span><span class="o">.</span><span class="n">traceback</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">called</span><span class="o">.</span><span class="n">traceback</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ThreadEndedByMaster</span><span class="p">:</span>
                <span class="c1">#                exception_count += 1</span>
                <span class="n">tracebacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
                <span class="n">last_exception</span> <span class="o">=</span> <span class="n">called</span><span class="o">.</span><span class="n">traceback</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">traceback_delay</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="o">*</span><span class="n">tb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">thread exception, but failed to print exception&quot;</span>
                    <span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;nones&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">called</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">called</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">called</span><span class="o">.</span><span class="n">result</span>

        <span class="c1"># Remove this thread from the dictionary of running threads</span>
        <span class="k">del</span> <span class="n">threads</span><span class="p">[</span><span class="n">called</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">concurrency_count</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># Clear the stop request, if there are no other threads that</span>
    <span class="c1"># still need to exit</span>
    <span class="k">if</span> <span class="n">concurrency_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">stop_request_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">stop_request_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Raise exceptions as necessary</span>
    <span class="k">if</span> <span class="n">parent_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">tb</span> <span class="ow">in</span> <span class="n">tracebacks</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="o">*</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">thread error (fixme to print message)&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">parent_exception</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracebacks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">catch</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracebacks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">last_exception</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tb</span> <span class="ow">in</span> <span class="n">tracebacks</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="o">*</span><span class="n">tb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">thread error (fixme to print message)&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ex</span> <span class="o">=</span> <span class="n">ConcurrentException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tracebacks</span><span class="p">)</span><span class="si">}</span><span class="s2"> call(s) raised exceptions&quot;</span><span class="p">)</span>
            <span class="n">ex</span><span class="o">.</span><span class="n">thread_exceptions</span> <span class="o">=</span> <span class="n">tracebacks</span>
            <span class="k">raise</span> <span class="n">ex</span>

    <span class="k">return</span> <span class="n">results</span>


<span class="nd">@hide_in_traceback</span>
<span class="k">def</span> <span class="nf">concurrently</span><span class="p">(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;If `*objs` are callable (like functions), call each of</span>
<span class="sd">     `*objs` in concurrent threads. If `*objs` are context</span>
<span class="sd">     managers (such as Device instances to be connected),</span>
<span class="sd">     enter each context in concurrent threads.</span>

<span class="sd">    Multiple references to the same function in `objs` only result in one call. The `catch` and `nones`</span>
<span class="sd">    arguments may be callables, in which case they are executed (and each flag value is treated as defaults).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        objs:  each argument may be a callable (function or class that defines a __call__ method), or context manager (such as a Device instance)</span>
<span class="sd">        catch:  if `False` (the default), a `ConcurrentException` is raised if any of `funcs` raise an exception; otherwise, any remaining successful calls are returned as normal</span>
<span class="sd">        nones: if not callable and evalues as True, includes entries for calls that return None (default is False)</span>
<span class="sd">        flatten: if `True`, results of callables that returns a dictionary are merged into the return dictionary with update (instead of passed through as dictionaries)</span>
<span class="sd">        traceback_delay: if `False`, immediately show traceback information on a thread exception; if `True` (the default), wait until all threads finish</span>
<span class="sd">    Returns:</span>
<span class="sd">        the values returned by each call</span>
<span class="sd">    :rtype: dictionary keyed by function name</span>

<span class="sd">    Here are some examples:</span>

<span class="sd">    :Example: Call each function `myfunc1` and `myfunc2`, each with no arguments:</span>

<span class="sd">    &gt;&gt;&gt; def do_something_1 ():</span>
<span class="sd">    &gt;&gt;&gt;     time.sleep(0.5)</span>
<span class="sd">    &gt;&gt;&gt;     return 1</span>
<span class="sd">    &gt;&gt;&gt; def do_something_2 ():</span>
<span class="sd">    &gt;&gt;&gt;     time.sleep(1)</span>
<span class="sd">    &gt;&gt;&gt;     return 2</span>
<span class="sd">    &gt;&gt;&gt; rets = concurrent(myfunc1, myfunc2)</span>
<span class="sd">    &gt;&gt;&gt; rets[do_something_1]</span>

<span class="sd">    :Example: To pass arguments, use the Call wrapper</span>

<span class="sd">    &gt;&gt;&gt; def do_something_3 (a,b,c):</span>
<span class="sd">    &gt;&gt;&gt;     time.sleep(2)</span>
<span class="sd">    &gt;&gt;&gt;     return a,b,c</span>
<span class="sd">    &gt;&gt;&gt; rets = concurrent(myfunc1, Call(myfunc3,a,b,c=c))</span>
<span class="sd">    &gt;&gt;&gt; rets[do_something_3]</span>
<span class="sd">    a, b, c</span>

<span class="sd">    **Caveats**</span>

<span class="sd">    - Because the calls are in different threads, not different processes,</span>
<span class="sd">      this should be used for IO-bound functions (not CPU-intensive functions).</span>
<span class="sd">    - Be careful about thread safety.</span>

<span class="sd">    When the callable object is a Device method, :func concurrency: checks</span>
<span class="sd">    the Device object state.concurrency for compatibility</span>
<span class="sd">    before execution. If this check returns `False`, this method</span>
<span class="sd">    raises a ConcurrentException.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">enter_or_call</span><span class="p">(</span><span class="n">concurrently_call</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="n">kws</span><span class="p">)</span>


<span class="nd">@hide_in_traceback</span>
<span class="k">def</span> <span class="nf">sequentially_call</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">name_func_pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Emulate `concurrently_call`, with sequential execution. This is mostly</span>
<span class="sd">    only useful to guarantee compatibility with `concurrently_call`</span>
<span class="sd">    dictionary-style returns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">wrappers</span> <span class="o">=</span> <span class="n">Call</span><span class="o">.</span><span class="n">wrap_list_to_dict</span><span class="p">(</span><span class="n">name_func_pairs</span><span class="p">)</span>

    <span class="c1"># Run each callable</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">wrapper</span> <span class="ow">in</span> <span class="n">wrappers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">wrapper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;nones&quot;</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>

    <span class="k">return</span> <span class="n">results</span>


<span class="nd">@hide_in_traceback</span>
<span class="k">def</span> <span class="nf">sequentially</span><span class="p">(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;If `*objs` are callable (like functions), call each of</span>
<span class="sd">     `*objs` in the given order. If `*objs` are context</span>
<span class="sd">     managers (such as Device instances to be connected),</span>
<span class="sd">     enter each context in the given order, and return a context manager</span>
<span class="sd">     suited for a `with` statement.</span>
<span class="sd">     This is the sequential implementation of the `concurrently` function,</span>
<span class="sd">     with a compatible convention of returning dictionaries.</span>

<span class="sd">    Multiple references to the same function in `objs` only result in one call. The `nones`</span>
<span class="sd">    argument may be callables in  case they are executed (and each flag value is treated as defaults).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        objs:  callables or context managers or Device instances for connections</span>
<span class="sd">        kws: dictionary of additional callables or Device instances for connections</span>
<span class="sd">        nones: `True` to include dictionary entries for calls that return None (default: False)</span>
<span class="sd">        flatten: `True` to flatten any `dict` return values into the return dictionary</span>
<span class="sd">    Returns:</span>
<span class="sd">        a dictionary keyed on the object name containing the return value of each function</span>
<span class="sd">    :rtype: dictionary of keyed by function</span>

<span class="sd">    Here are some examples:</span>

<span class="sd">    :Example: Call each function `myfunc1` and `myfunc2`, each with no arguments:</span>

<span class="sd">    &gt;&gt;&gt; def do_something_1 ():</span>
<span class="sd">    &gt;&gt;&gt;     time.sleep(0.5)</span>
<span class="sd">    &gt;&gt;&gt;     return 1</span>
<span class="sd">    &gt;&gt;&gt; def do_something_2 ():</span>
<span class="sd">    &gt;&gt;&gt;     time.sleep(1)</span>
<span class="sd">    &gt;&gt;&gt;     return 2</span>
<span class="sd">    &gt;&gt;&gt; rets = concurrent(myfunc1, myfunc2)</span>
<span class="sd">    &gt;&gt;&gt; rets[do_something_1]</span>
<span class="sd">    1</span>

<span class="sd">    :Example: To pass arguments, use the Call wrapper</span>

<span class="sd">    &gt;&gt;&gt; def do_something_3 (a,b,c):</span>
<span class="sd">    &gt;&gt;&gt;     time.sleep(2)</span>
<span class="sd">    &gt;&gt;&gt;     return a,b,c</span>
<span class="sd">    &gt;&gt;&gt; rets = concurrent(myfunc1, Call(myfunc3,a,b,c=c))</span>
<span class="sd">    &gt;&gt;&gt; rets[do_something_3]</span>
<span class="sd">    a, b, c</span>

<span class="sd">    **Caveats**</span>

<span class="sd">    - Unlike `concurrently`, an exception in a context manager&#39;s __enter__</span>
<span class="sd">      means that any remaining context managers will not be entered.</span>

<span class="sd">    When the callable object is a Device method, :func concurrency: checks</span>
<span class="sd">    the Device object state.concurrency for compatibility</span>
<span class="sd">    before execution. If this check returns `False`, this method</span>
<span class="sd">    raises a ConcurrentException.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">enter_or_call</span><span class="p">(</span><span class="n">sequentially_call</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="n">kws</span><span class="p">)</span>


<span class="n">OP_CALL</span> <span class="o">=</span> <span class="s2">&quot;op&quot;</span>
<span class="n">OP_GET</span> <span class="o">=</span> <span class="s2">&quot;get&quot;</span>
<span class="n">OP_SET</span> <span class="o">=</span> <span class="s2">&quot;set&quot;</span>
<span class="n">OP_QUIT</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">ThreadDelegate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_sandbox</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_obj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_repr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">dir_</span><span class="p">,</span> <span class="n">repr_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sandbox</span> <span class="o">=</span> <span class="n">sandbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span> <span class="o">=</span> <span class="n">dir_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repr</span> <span class="o">=</span> <span class="n">repr_</span>

    <span class="nd">@hide_in_traceback</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sandbox</span><span class="p">,</span> <span class="n">OP_CALL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kws</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">delegate_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sandbox</span><span class="p">,</span> <span class="n">OP_GET</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ThreadDelegate(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_repr</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">delegate_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sandbox</span><span class="p">,</span> <span class="n">OP_SET</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="n">delegate_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ThreadDelegate</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


<span class="nd">@hide_in_traceback</span>
<span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="n">sandbox</span><span class="p">,</span> <span class="o">*</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">_requestq</span><span class="p">,</span> <span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Await and handle request. Exception should be raised in this</span>
    <span class="c1"># (main) thread</span>
    <span class="n">req</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="p">(</span><span class="n">rsp</span><span class="p">,),</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">exc</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exc</span>

    <span class="k">return</span> <span class="n">ret</span>


<div class="viewcode-block" id="ThreadSandbox"><a class="viewcode-back" href="../../labbench.html#labbench.ThreadSandbox">[docs]</a><span class="k">class</span> <span class="nc">ThreadSandbox</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute all calls in the class in a separate background thread. This</span>
<span class="sd">    is intended to work around challenges in threading wrapped win32com APIs.</span>

<span class="sd">    Use it as follows:</span>

<span class="sd">        obj = ThreadSandbox(MyClass(myclassarg, myclasskw=myclassvalue))</span>

<span class="sd">    Then use `obj` as a normal MyClass instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__repr_root__</span> <span class="o">=</span> <span class="s2">&quot;uninitialized ThreadSandbox&quot;</span>
    <span class="n">__dir_root__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">__thread</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_requestq</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">should_sandbox_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Start the thread and block until it&#39;s ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requestq</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ready</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="n">should_sandbox_func</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="n">ready</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span>

    <span class="nd">@hide_in_traceback</span>
    <span class="k">def</span> <span class="nf">__worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="n">sandbox_check_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is the only thread allowed to access the protected object.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">factory</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">default_sandbox_check_func</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                        <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">sandbox_check_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sandbox_check_func</span> <span class="o">=</span> <span class="n">default_sandbox_check_func</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__repr_root__</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dir_root__</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">sandbox_keys</span><span class="p">))))</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">ready</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Do some sort of setup here</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">op</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kws</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requestq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># End if that&#39;s good</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="n">OP_QUIT</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">root</span>

            <span class="c1"># Do the op</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="n">OP_GET</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">is</span> <span class="n">OP_CALL</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">is</span> <span class="n">OP_SET</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

                <span class="c1"># Make it a delegate if it needs to be protected</span>
                <span class="k">if</span> <span class="n">sandbox_check_func</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ThreadDelegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">dir_</span><span class="o">=</span><span class="nb">dir</span><span class="p">(</span><span class="n">ret</span><span class="p">),</span> <span class="n">repr_</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>

            <span class="c1"># Catch all exceptions</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">e</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">e</span>

            <span class="n">rsp</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">ret</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ThreadSandbox worker thread finished&quot;</span><span class="p">)</span>

    <span class="nd">@hide_in_traceback</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sandbox_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_GET</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@hide_in_traceback</span>
    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sandbox_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_SET</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_QUIT</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="p">,</span> <span class="n">Thread</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no thread running to kill&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">del_</span> <span class="o">=</span> <span class="n">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OP_GET</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;__del__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">del_</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ThreadSandbox(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__repr_root__</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dir_root__</span></div>


<span class="n">sandbox_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ThreadSandbox</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


<div class="viewcode-block" id="ConfigStore"><a class="viewcode-back" href="../../labbench.html#labbench.ConfigStore">[docs]</a><span class="k">class</span> <span class="nc">ConfigStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define dictionaries of configuration value traits</span>
<span class="sd">    in subclasses of this object. Each dictionary should</span>
<span class="sd">    be an attribute of the subclass. The all() class method</span>
<span class="sd">    returns a flattened dictionary consisting of all values</span>
<span class="sd">    of these dictionary attributes, keyed according to</span>
<span class="sd">    &#39;{attr_name}_{attr_key}&#39;, where {attr_name} is the</span>
<span class="sd">    name of the dictionary attribute and {attr_key} is the</span>
<span class="sd">    nested dictionary key.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConfigStore.all"><a class="viewcode-back" href="../../labbench.html#labbench.ConfigStore.all">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dictionary of all attributes in the class&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="ConfigStore.frame"><a class="viewcode-back" href="../../labbench.html#labbench.ConfigStore.frame">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">frame</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a pandas DataFrame containing all attributes</span>
<span class="sd">        in the class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="bp">cls</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Value&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Parameter&quot;</span>
        <span class="k">return</span> <span class="n">df</span></div></div>


<span class="k">def</span> <span class="nf">accessed_attributes</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;enumerate the attributes of the parent class accessed by `method`</span>

<span class="sd">    :method: callable that is a method or defined in a class</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple of attribute names</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># really won&#39;t work unless method is a callable defined inside a class</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isroutine</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> is not a method&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">method</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> is not defined in a class&quot;</span><span class="p">)</span>

    <span class="c1"># parse into a code tree</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

    <span class="c1"># filter out lines that start with comments, which have no tokens and confuse textwrap.dedent</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;^[ </span><span class="se">\t\r\n</span><span class="s2">]*[^#].*&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">))</span>

    <span class="n">parsed</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># this should not be possible</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ast parsing gave unexpected extra nodes&quot;</span><span class="p">)</span>

    <span class="c1"># pull out the function node and the name for the class instance</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;this object doesn&#39;t look like a method&quot;</span><span class="p">)</span>

    <span class="n">self_name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">arg</span>

    <span class="k">def</span> <span class="nf">isselfattr</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">self_name</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">({</span><span class="n">node</span><span class="o">.</span><span class="n">attr</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="k">if</span> <span class="n">isselfattr</span><span class="p">(</span><span class="n">node</span><span class="p">)})</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench vgit</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">labbench.util</a></li> 
      </ul>
    </div>
<hr \>
<section class="footer">
<br><a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#privpolicy">Privacy Policy</a> | <a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#secnot">Security Notice</a> | <a href="http://www.nist.gov/public_affairs/privacy.cfm#accesstate">Accessibility Statement</a>
<br><em>United States government work, not subject to copyright in the United States</em>
</section>

  </body>
</html>