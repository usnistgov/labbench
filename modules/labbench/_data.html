<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>labbench._data &#8212; labbench vgit</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
<header class="nist-header">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>NIST Pages Template</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="labbench vgit">
  <link rel="canonical" href="../../">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- Google Analytics -->
  <!--<script type="text/javascript" id="_fed_an_js_tag" src="http://www.nist.gov/js/federated-analytics.all.min.js?agency=NIST&subagency=mml&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script> -->
  <!-- DAP Analytics -->
  <script type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&subagefncy=NIST&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../..//static/NISTStyle.css">
  <link rel="stylesheet" href="../..//static/NISTPages.css">

  <h1>
    <a class="nist-logo" target="_blank" href="http://www.nist.gov/" title="Go to nist.gov">National Institute of Standards and Technology</a>
  </h1>
  <div class="nist-links">
    <a class="nist-links-button" target="_blank" href="http://www.nist.gov">NIST Website</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="http://www.nist.gov/public_affairs/nandyou.cfm">About NIST</a>
    <a class="nist-links-button mobile-hide" target="_blank" href="https://github.com/usnistgov">usnistgov on GitHub</a>
  </div>
  
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</header>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench vgit</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">labbench._data</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for labbench._data</h1><div class="highlight"><pre>
<span></span><span class="c1"># This software was developed by employees of the National Institute of</span>
<span class="c1"># Standards and Technology (NIST), an agency of the Federal Government.</span>
<span class="c1"># Pursuant to title 17 United States Code Section 105, works of NIST employees</span>
<span class="c1"># are not subject to copyright protection in the United States and are</span>
<span class="c1"># considered to be in the public domain. Permission to freely use, copy,</span>
<span class="c1"># modify, and distribute this software and its documentation without fee is</span>
<span class="c1"># hereby granted, provided that this notice and disclaimer of warranty appears</span>
<span class="c1"># in all copies.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &#39;AS IS&#39; WITHOUT ANY WARRANTY OF ANY KIND, EITHER</span>
<span class="c1"># EXPRESSED, IMPLIED, OR STATUTORY, INCLUDING, BUT NOT LIMITED TO, ANY WARRANTY</span>
<span class="c1"># THAT THE SOFTWARE WILL CONFORM TO SPECIFICATIONS, ANY IMPLIED WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND FREEDOM FROM</span>
<span class="c1"># INFRINGEMENT, AND ANY WARRANTY THAT THE DOCUMENTATION WILL CONFORM TO THE</span>
<span class="c1"># SOFTWARE, OR ANY WARRANTY THAT THE SOFTWARE WILL BE ERROR FREE. IN NO EVENT</span>
<span class="c1"># SHALL NIST BE LIABLE FOR ANY DAMAGES, INCLUDING, BUT NOT LIMITED TO, DIRECT,</span>
<span class="c1"># INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES, ARISING OUT OF, RESULTING FROM,</span>
<span class="c1"># OR IN ANY WAY CONNECTED WITH THIS SOFTWARE, WHETHER OR NOT BASED UPON</span>
<span class="c1"># WARRANTY, CONTRACT, TORT, OR OTHERWISE, WHETHER OR NOT INJURY WAS SUSTAINED</span>
<span class="c1"># BY PERSONS OR PROPERTY OR OTHERWISE, AND WHETHER OR NOT LOSS WAS SUSTAINED</span>
<span class="c1"># FROM, OR AROSE OUT OF THE RESULTS OF, OR USE OF, THE SOFTWARE OR SERVICES</span>
<span class="c1"># PROVIDED HEREUNDER. Distributions of NIST software should also include</span>
<span class="c1"># copyright and licensing statements of any third-party software that are</span>
<span class="c1"># legally bundled with the code in compliance with the conditions of those</span>
<span class="c1"># licenses.</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">suppress</span><span class="p">,</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_device</span><span class="p">,</span> <span class="n">_traits</span><span class="p">,</span> <span class="n">_rack</span>
<span class="kn">from</span> <span class="nn">._device</span> <span class="kn">import</span> <span class="n">Device</span>
<span class="kn">from</span> <span class="nn">._traits</span> <span class="kn">import</span> <span class="n">observe</span>
<span class="kn">from</span> <span class="nn">._rack</span> <span class="kn">import</span> <span class="n">Owner</span><span class="p">,</span> <span class="n">Rack</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_host</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_device</span> <span class="k">as</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">value</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">EMPTY</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span>

<span class="n">INSPECT_SKIP_FILES</span> <span class="o">=</span> <span class="n">_device</span><span class="o">.</span><span class="vm">__file__</span><span class="p">,</span> <span class="n">_traits</span><span class="o">.</span><span class="vm">__file__</span><span class="p">,</span> <span class="n">_rack</span><span class="o">.</span><span class="vm">__file__</span><span class="p">,</span> <span class="vm">__file__</span>


<span class="k">class</span> <span class="nc">MungerBase</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Organize file output with a key in the root database.</span>

<span class="sd">    The following conversions to relational files are attempted in order to</span>
<span class="sd">    convert each value in the row dictionary:</span>

<span class="sd">    1. Text containing a valid file or directory *outside* of the root data</span>
<span class="sd">       directory is made relational by moving the file or directory into</span>
<span class="sd">       the current row. The text is replaced with the updated relative path;</span>
<span class="sd">    2. Text longer than `text_relational_min` is dumped into a relational</span>
<span class="sd">       text file;</span>
<span class="sd">    3. 1- or 2-D data is converted to a pandas Series or DataFrame, and</span>
<span class="sd">       dumped into a relational file defined by the extension set by</span>
<span class="sd">       `nonscalar_file_type`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">resource</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;base directory for all data&quot;</span><span class="p">)</span>
    <span class="n">text_relational_min</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">int</span><span class="p">(</span>
        <span class="mi">1024</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;minimum size threshold that triggers storing text in a relational file&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">force_relational</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;host_log&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;list of column names to always save as relational data&quot;</span>
    <span class="p">)</span>
    <span class="n">dirname_fmt</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{id}</span><span class="s2"> </span><span class="si">{host_time}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;directory name format for data in each row keyed on column&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">nonscalar_file_type</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span>
        <span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;file format for non-scalar numerical data&quot;</span>
    <span class="p">)</span>
    <span class="n">metadata_dirname</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;subdirectory name for metadata&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Break special cases of row items that need to be stored in</span>
<span class="sd">        relational files. The row valueis replaced in-place with the relative</span>
<span class="sd">        path to the data saved on disk.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            row: dictionary of {&#39;entry_name&#39;: &quot;entry_value&quot;} pairs</span>
<span class="sd">        Returns:</span>
<span class="sd">            the row dictionary, replacing special entries with the relative path to the saved data file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="k">def</span> <span class="nf">is_path</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">is_path</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="c1"># Path to a datafile to move into the dataset</span>
                <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_external_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="c1"># A long string that should be written to a text file</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_relational_min</span>
                    <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_relational</span>
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_text</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)):</span>
                <span class="c1"># vector, table, matrix, etc.</span>
                <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_ndarraylike</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="c1"># tuple, list, or other iterable</span>
                <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_sequence</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">save_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key_func</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">def</span> <span class="nf">process_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">key_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_relational_min</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_from_text</span><span class="p">(</span><span class="n">key_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_from_ndarraylike</span><span class="p">(</span><span class="n">key_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">owner</span><span class="p">,</span> <span class="n">owner_name</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">owner</span><span class="o">.</span><span class="n">_traits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">_traits</span><span class="o">.</span><span class="n">Trait</span><span class="o">.</span><span class="n">ROLE_VALUE</span> <span class="ow">or</span> <span class="n">trait</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
                    <span class="n">summary</span><span class="p">[</span><span class="n">key_func</span><span class="p">(</span><span class="n">owner_name</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">owner</span><span class="p">,</span> <span class="n">trait_name</span>
                    <span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">process_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">summary</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_from_ndarraylike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write nonscalar (potentially array-like, or a python object) data</span>
<span class="sd">        to a file, and return a path to the file</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: name of the entry to write, used as the filename</span>
<span class="sd">            value: the object containing array-like data</span>
<span class="sd">            row: row dictionary, or None (the default) to write to the metadata folder</span>
<span class="sd">        Returns:</span>
<span class="sd">            the path to the file, relative to the directory that contains the root database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;pickle&quot;</span><span class="p">):</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;feather&quot;</span><span class="p">:</span>
                <span class="n">to_feather</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;db&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;sqlite not implemented for relational files&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extension </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2"> doesn&#39;t match a known format&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonscalar_file_type</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="c1"># We couldn&#39;t make a DataFrame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to form DataFrame from </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">; pickling object instead&quot;</span>
            <span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;pickle&quot;</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_metadata</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_relational</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span>

            <span class="c1"># Workaround for bytes/str encoding quirk underlying pandas 0.23.1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">write</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
                    <span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_external_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntries</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_relational</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_import_from_file</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a string data to a file</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: name of the parameter (helps to determine file path)</span>
<span class="sd">            value: the string to write to file</span>
<span class="sd">            row: the row to infer timestamp, or None to write to metadata</span>
<span class="sd">            ext: file extension</span>
<span class="sd">        Returns:</span>
<span class="sd">            the path to the file, relative to the directory that contains the root database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_relational</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a string data to a file</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: name of the parameter (helps to determine file path)</span>
<span class="sd">            value: the string to write to file</span>
<span class="sd">            row: the row to infer timestamp, or None to write to metadata</span>
<span class="sd">            ext: file extension</span>
<span class="sd">        Returns:</span>
<span class="sd">            the path to the file, relative to the directory that contains the root database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_relational</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># f.write(bytes(value, encoding=&#39;utf-8&#39;))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># The following methods need to be implemented in subclasses.</span>
    <span class="k">def</span> <span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Key to use for the relative data in the root database?</span>

<span class="sd">        Arguments:</span>
<span class="sd">            stream: stream for writing to the relational data file</span>
<span class="sd">        Returns:</span>
<span class="sd">            the key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_open_relational</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open a stream / IO buffer for writing relational data, given</span>
<span class="sd">        the root database column, index, and the row dictionary.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: the column name of the relational data in the root db</span>
<span class="sd">            index: the index name of of the data in the root db</span>
<span class="sd">            row: the dictionary containing the row of data at `index`</span>

<span class="sd">        Returns:</span>

<span class="sd">            an open buffer object for writing data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_open_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open a stream / IO buffer for writing metadata, given</span>
<span class="sd">        the name of the metadata.</span>

<span class="sd">        Returns:</span>

<span class="sd">            an open buffer object for writing metadata to the file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_import_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make sure these are fresh in the module cache</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">class</span> <span class="nc">MungeToDirectory</span><span class="p">(</span><span class="n">MungerBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implement data munging into subdirectories.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_open_relational</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;host_time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;no timestamp yet from host yet; this shouldn&#39;t happen :(&quot;</span>
            <span class="p">)</span>

        <span class="n">relpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_path_heirarchy</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">relpath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_dirname</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">FileExistsError</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Key to use for the relative data in the root database?</span>

<span class="sd">        Arguments:</span>
<span class="sd">            stream: stream for writing to the relational data file</span>
<span class="sd">        Returns:</span>
<span class="sd">            the key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_import_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="c1"># Retry moves for several seconds in case the file is in the process</span>
        <span class="c1"># of being closed</span>
        <span class="nd">@util</span><span class="o">.</span><span class="n">until_timeout</span><span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">move</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">move</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;moved </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;relational file was still open in another program; fallback to copy instead of rename&quot;</span>
            <span class="p">)</span>
            <span class="kn">import</span> <span class="nn">shutil</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_path_heirarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirname_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># TODO: Find a more generic way to force valid path name</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">relpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relpath</span>

    <span class="k">def</span> <span class="nf">_write_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">def</span> <span class="nf">recursive_dict_fix</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">recursive_dict_fix</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">d</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_metadata</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">):</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">recursive_dict_fix</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="c1"># with io.TextIOWrapper(stream, newline=&#39;\n&#39;) as buf:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TarFileIO</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For appending data into new files in a tarfile&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">open_tarfile</span><span class="p">,</span> <span class="n">relname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#        self.tarbase = tarbase</span>
        <span class="c1">#        self.tarname = tarname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span> <span class="o">=</span> <span class="n">open_tarfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">relname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TarFileIO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TarFileIO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TarFileIO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>

    <span class="c1">#    def write(self, data, encoding=&#39;ascii&#39;):</span>
    <span class="c1">#        if isinstance(data, str):</span>
    <span class="c1">#            data = bytes(data, encoding=encoding)</span>
    <span class="c1">#        super(TarFileIO,self).write(data)</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># First: dump the data into the tar file</span>
        <span class="c1">#        tarpath = os.path.join(self.tarbase, self.tarname)</span>
        <span class="c1">#        f = tarfile.open(tarpath, &#39;a&#39;)</span>

        <span class="kn">import</span> <span class="nn">tarfile</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="o">.</span><span class="n">getnames</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already exists in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">tarinfo</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Then make sure to close everything</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TarFileIO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">MungeToTar</span><span class="p">(</span><span class="n">MungerBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implement data munging into a tar file. This is slower than</span>
<span class="sd">    MungeToDirectory but is tidier on the filesystem.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tarname</span> <span class="o">=</span> <span class="s2">&quot;data.tar&quot;</span>

    <span class="k">def</span> <span class="nf">_open_relational</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;host_time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;no timestamp yet from host yet; this shouldn&#39;t happen :(&quot;</span>
            <span class="p">)</span>

        <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="n">row</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TarFileIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="p">,</span> <span class="n">relpath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_dirname</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TarFileIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tarfile</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">FileExistsError</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tarname</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">util</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MungeToTar cleanup()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Where is the file relative to the root database?</span>

<span class="sd">        Arguments:</span>
<span class="sd">            path: path of the file</span>
<span class="sd">        Returns:</span>
<span class="sd">            path to the file relative to the root database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">_import_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gettarinfo</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

        <span class="nd">@util</span><span class="o">.</span><span class="n">until_timeout</span><span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">remove</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NotADirectoryError</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">remove</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;moved </span><span class="si">{</span><span class="n">old_path</span><span class="si">}</span><span class="s2"> to into tar file as </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not remove old file or directory </span><span class="si">{</span><span class="n">old_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_metadata</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">):</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;Value&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Aggregator</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Ownable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Passive aggregation of data from Device property trait and value traits traits, and from calls to methods in Rack instances&quot;&quot;&quot;</span>

    <span class="n">PERSISTENT_TRAIT_ROLES</span> <span class="o">=</span> <span class="p">(</span><span class="n">_traits</span><span class="o">.</span><span class="n">Trait</span><span class="o">.</span><span class="n">ROLE_VALUE</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># registry of names to use for trait owners</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trait_rules</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">always</span><span class="o">=</span><span class="p">{},</span> <span class="n">never</span><span class="o">=</span><span class="p">{})</span>

        <span class="c1"># pending data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_volatile</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{}</span>
        <span class="p">)</span>  <span class="c1"># pending = dict(state={}, value traits={}, rack={})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_persistent</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_rack_output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_rack_input</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rack_toplevel_caller</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rack_input_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># self._iter_index_names = {}</span>

        <span class="c1"># cached data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">()&quot;</span>

    <span class="k">def</span> <span class="nf">enable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># catch return data as well</span>
        <span class="n">_rack</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">observe_returns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_receive_rack_output</span><span class="p">)</span>
        <span class="n">_rack</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">observe_calls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_receive_rack_input</span><span class="p">)</span>
        <span class="c1"># _rack.notify.observe_call_iteration(self._receive_rack_iteration)</span>

    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_rack</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">unobserve_returns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_receive_rack_output</span><span class="p">)</span>
        <span class="n">_rack</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">unobserve_calls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_receive_rack_input</span><span class="p">)</span>
        <span class="c1"># _rack.notify.unobserve_call_iteration(self._receive_rack_input)</span>

    <span class="k">def</span> <span class="nf">is_persistent_trait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">trait</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">_traits</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">trait</span><span class="o">.</span><span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PERSISTENT_TRAIT_ROLES</span> <span class="ow">or</span> <span class="n">trait</span><span class="o">.</span><span class="n">cache</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">([</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return an aggregated dictionary output data (from Device traits and Rack method returns)</span>
<span class="sd">        and an aggregated dictionary of input data (keyword arguments passed to the toplevel Rack method).</span>
<span class="sd">        A get is</span>
<span class="sd">        also performed on each Device trait that is configured as &quot;always&quot; with `self.observe`, and any traits</span>
<span class="sd">        labeled &quot;never&quot; are removed.</span>

<span class="sd">        Returns:</span>

<span class="sd">            dictionary keyed on :func:`key` (defaults &#39;{device name}_{state name}&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">device</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># Perform gets for each property trait called out in self.trait_rules[&#39;always&#39;]</span>
            <span class="k">if</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_rules</span><span class="p">[</span><span class="s2">&quot;always&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_rules</span><span class="p">[</span><span class="s2">&quot;always&quot;</span><span class="p">][</span><span class="n">device</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_persistent_trait</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_persistent</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                            <span class="n">device</span><span class="p">,</span> <span class="n">attr</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_volatile</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                            <span class="n">device</span><span class="p">,</span> <span class="n">attr</span>
                        <span class="p">)</span>

            <span class="c1"># Remove keys corresponding with self.trait_rules[&#39;never&#39;]</span>
            <span class="k">if</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_rules</span><span class="p">[</span><span class="s2">&quot;never&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trait_rules</span><span class="p">[</span><span class="s2">&quot;never&quot;</span><span class="p">][</span><span class="n">device</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_persistent_trait</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_persistent</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_volatile</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">aggregated_output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rack_input_index</span><span class="p">)</span>

        <span class="c1"># start by aggregating the trait data, and checking for conflicts with keys in the Rack data</span>
        <span class="n">aggregated_output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_persistent</span><span class="p">)</span>
        <span class="n">aggregated_output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_volatile</span><span class="p">)</span>

        <span class="c1"># check namespace conflicts and pull in rack outputs</span>
        <span class="n">key_conflicts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">aggregated_output</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_rack_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_conflicts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;key name conflict in aggregated data - Rack data is overwriting trait data for </span><span class="si">{</span><span class="n">key_conflicts</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">aggregated_output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_rack_output</span><span class="p">)</span>

        <span class="c1"># and the rack inputs</span>
        <span class="n">aggregated_input</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rack_input_index</span><span class="p">)</span>
        <span class="n">aggregated_input</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_rack_input</span><span class="p">)</span>

        <span class="c1"># clear Rack data, as well as property trait data if we don&#39;t assume it is consistent.</span>
        <span class="c1"># value traits traits are locally cached, so it is safe to keep them in the next step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_rack_output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_volatile</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># self._pending_rack_input = {}</span>

        <span class="k">return</span> <span class="n">aggregated_output</span><span class="p">,</span> <span class="n">aggregated_input</span>

    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">state_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a name for a trait based on the names of</span>
<span class="sd">        a device and one of its states or value traits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">state_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">set_device_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Manually choose device name for a device instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            mapping (dict): name mapping, formatted as {device_object: &#39;device name&#39;}</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">device</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">Aggregator</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">Device</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> is not an instance of Device&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">_receive_rack_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;called by an owning Rack notifying that managed procedural steps have returned data&quot;&quot;&quot;</span>
        <span class="c1"># trait data or previous returned data may cause problems here. perhaps this should be an exception?</span>

        <span class="n">row_data</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span>

        <span class="n">key_conflicts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_rack_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_conflicts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Rack call overwrites prior data with existing keys </span><span class="si">{</span><span class="n">key_conflicts</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_rack_output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_receive_rack_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;called by an owning Rack notifying that managed procedural steps have returned data&quot;&quot;&quot;</span>
        <span class="c1"># trait data or previous returned data may cause problems here. perhaps this should be an exception?</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rack_toplevel_caller</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># take the first call as the top-level caller</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rack_toplevel_caller</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;owner&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rack_toplevel_caller</span> <span class="o">!=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;owner&quot;</span><span class="p">]:</span>
            <span class="c1"># only track calls to the top-level caller</span>
            <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rack_input_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># iter_info = msg[&quot;new&quot;]</span>
        <span class="n">row_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rack_input_index</span><span class="p">)</span>

        <span class="c1"># if len(self._iter_index_names) &gt; 0:</span>
        <span class="c1">#     self._iter_index_names.setdefault(</span>
        <span class="c1">#         msg[&quot;owner&quot;], &quot;index_&quot; + msg[&quot;owner&quot;]._owned_name</span>
        <span class="c1">#     )</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self._iter_index_names.setdefault(msg[&quot;owner&quot;], &quot;index&quot;)</span>

        <span class="c1"># row_data[self._iter_index_names[msg[&quot;owner&quot;]]] = iter_info[&quot;index&quot;]</span>
        <span class="c1"># if iter_info[&#39;step_name&#39;]:</span>
        <span class="c1">#     row_data[msg[&#39;owner&#39;]._owned_name + &#39;_step_name&#39;] = iter_info[&#39;step_name&#39;]</span>

        <span class="c1"># TODO: should there be some kind of conflict check for this?</span>
        <span class="c1"># key_conflicts = set(row_data).intersection(self._pending_traits_persistent)</span>
        <span class="c1"># if len(key_conflicts) &gt; 0:</span>
        <span class="c1">#     self._logger.warning(</span>
        <span class="c1">#         f&quot;Rack call overwrites prior data with existing keys {key_conflicts}&quot;</span>
        <span class="c1">#     )</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_rack_input</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span> <span class="o">**</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_receive_trait_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;called by trait owners on changes observed</span>

<span class="sd">        Arguments:</span>
<span class="sd">            msg (dict): callback info dictionary generated by traitlets</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="c1"># skip private traits</span>
            <span class="k">return</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;owner&quot;</span><span class="p">]]</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;cache&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_persistent_trait</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;owner&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_persistent</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending_traits_volatile</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_update_name_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rack_or_devices</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;map each Device to a name in devices.values() by introspection&quot;&quot;&quot;</span>

        <span class="c1"># self.name_map.clear()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rack_or_devices</span><span class="p">,</span> <span class="n">Rack</span><span class="p">):</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">obj</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">Rack</span><span class="o">.</span><span class="n">_ownables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Device</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="n">rack_or_devices</span>

        <span class="k">for</span> <span class="n">device</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">Device</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> is not an instance of Device&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="p">[</span><span class="n">device</span><span class="p">]:</span>
                    <span class="c1"># a rename is an odd case, make a note of it</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;renaming </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="p">[</span><span class="n">device</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

            <span class="k">elif</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="p">:</span>
                <span class="c1"># naming for device. needs this</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="p">[</span><span class="n">device</span><span class="p">]</span>

            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
                <span class="c1"># Ownable instances that have owners have this attribute set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="vm">__name__</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_object_in_callers</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> named &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; by introspection&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">])</span>

            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;could not automatically resolve duplicate device name(s) </span><span class="si">{</span><span class="n">duplicates</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="p">[],</span> <span class="n">never</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;isopen&quot;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure the data to aggregate from value, property, or datareturn traits in the given devices.</span>

<span class="sd">        Device may be a single device instance, or an</span>
<span class="sd">        several devices in an iterable (such as a list</span>
<span class="sd">        or tuple) to apply to each one.</span>

<span class="sd">        Subsequent calls to :func:`observe_states` replace</span>
<span class="sd">        the existing list of observed property traits for each</span>
<span class="sd">        device.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            devices: Device instance, iterable of Devices, or {device:name} mapping</span>
<span class="sd">            changes (bool): Whether to automatically log each time a property trait is set for the supplied device(s)</span>
<span class="sd">            always: name (or iterable of multiple names) of property traits to actively update on each call to get()</span>
<span class="sd">            never: name (or iterable of multiple names) of property traits to exclude from aggregated result (overrides :param:`always`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># parameter checks</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">Device</span><span class="p">):</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="p">{</span><span class="n">devices</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">d</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;devices argument must be a device or iterable of devices&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">always</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">always</span> <span class="o">=</span> <span class="p">(</span><span class="n">always</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">always</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="n">always</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">always</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;argument &#39;always&#39; must be a str or iterable of str&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">never</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">never</span> <span class="o">=</span> <span class="p">(</span><span class="n">never</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">never</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="n">never</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">never</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;argument &#39;never&#39; must be a str or iterable of str&quot;</span><span class="p">)</span>

        <span class="c1"># if isinstance(role, (str,bytes)):</span>
        <span class="c1">#     role = [role]</span>
        <span class="c1"># TODO: remove this for good?</span>
        <span class="c1"># if role not in VALID_TRAIT_ROLES:</span>
        <span class="c1">#     raise ValueError(f&quot;the &#39;role&#39; argument must be one of {str(VALID_TRAIT_ROLES)}, not {role}&quot;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_name_map</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span>

        <span class="c1"># Register handlers</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">changes</span><span class="p">:</span>
                <span class="n">observe</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_trait_update</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">core</span><span class="o">.</span><span class="n">unobserve</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_trait_update</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">always</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trait_rules</span><span class="p">[</span><span class="s2">&quot;always&quot;</span><span class="p">][</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">always</span>
            <span class="k">if</span> <span class="n">never</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trait_rules</span><span class="p">[</span><span class="s2">&quot;never&quot;</span><span class="p">][</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">never</span>

    <span class="k">def</span> <span class="nf">_find_object_in_callers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">max_levels</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Introspect into the caller to name an object .</span>

<span class="sd">        Arguments:</span>
<span class="sd">            target: device instance</span>
<span class="sd">            min_levels: minimum number of layers of calls to traverse</span>
<span class="sd">            max_levels: maximum number of layers to traverse</span>
<span class="sd">        Returns:</span>
<span class="sd">            name of the Device</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#        # If the context is a function, look in its first argument,</span>
        <span class="c1">#        # in case it is a method. Search its class instance.</span>
        <span class="c1">#        if len(ret) == 0 and len(f.frame.f_code.co_varnames)&gt;0:</span>
        <span class="c1">#            obj = f.frame.f_locals[f.frame.f_code.co_varnames[0]]</span>
        <span class="c1">#            for k, v in obj.__dict__.items():</span>
        <span class="c1">#                if isinstance(v, Device):</span>
        <span class="c1">#                    ret[k] = v</span>

        <span class="k">def</span> <span class="nf">find_value</span><span class="p">(</span><span class="n">haystack</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="n">reject</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">haystack</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">needle</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reject</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">k</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">f</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span> <span class="ow">in</span> <span class="n">INSPECT_SKIP_FILES</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">f_back</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_levels</span><span class="p">):</span>
                <span class="c1"># look in the namespace; if nothing</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">find_value</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">f_locals</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">f_back</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to automatically label </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">f</span><span class="p">,</span> <span class="n">frame</span>

        <span class="k">return</span> <span class="n">ret</span>


<span class="k">class</span> <span class="nc">RelationalTableLogger</span><span class="p">(</span>
    <span class="n">Owner</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">Ownable</span><span class="p">,</span> <span class="n">entry_order</span><span class="o">=</span><span class="p">(</span><span class="n">_host</span><span class="o">.</span><span class="n">Email</span><span class="p">,</span> <span class="n">MungerBase</span><span class="p">,</span> <span class="n">_host</span><span class="o">.</span><span class="n">Host</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for loggers that queue dictionaries of data before writing</span>
<span class="sd">    to disk. This extends :class:`Aggregator` to support</span>

<span class="sd">    #. queuing aggregate property trait of devices by lists of dictionaries;</span>
<span class="sd">    #. custom metadata in each queued aggregate property trait entry; and</span>
<span class="sd">    #. custom response to non-scalar data (such as relational databasing).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        path (str): Base path to use for the root database</span>
<span class="sd">        overwrite (bool): Whether to overwrite the root database if it exists (otherwise, append)</span>

<span class="sd">        text_relational_min: Text with at least this many characters is stored as a relational text file instead of directly in the database</span>
<span class="sd">        force_relational: A list of columns that should always be stored as relational data instead of directly in the database</span>

<span class="sd">    Arguments:</span>
<span class="sd">        nonscalar_file_type: The data type to use in non-scalar (tabular, vector, etc.) relational data</span>
<span class="sd">        metadata_dirname: The name of the subdirectory that should be used to store metadata (device connection parameters, etc.)</span>

<span class="sd">        tar: Whether to store the relational data within directories in a tar file, instead of subdirectories</span>
<span class="sd">        git_commit_in: perform a git commit on open() if the current</span>
<span class="sd">        directory is inside a git repo with this branch name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">index_label</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">text_relational_min</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
        <span class="n">force_relational</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;host_log&quot;</span><span class="p">],</span>
        <span class="n">dirname_fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{id}</span><span class="s2"> </span><span class="si">{host_time}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">nonscalar_file_type</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">metadata_dirname</span><span class="o">=</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
        <span class="n">tar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">git_commit_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># **metadata</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="o">=</span> <span class="n">Aggregator</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># log host introspection</span>
        <span class="c1"># TODO: smarter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">_host</span><span class="o">.</span><span class="n">Host</span><span class="p">(</span><span class="n">git_commit_in</span><span class="o">=</span><span class="n">git_commit_in</span><span class="p">)</span>

        <span class="c1"># select the backend that dumps relational data</span>
        <span class="n">munge_cls</span> <span class="o">=</span> <span class="n">MungeToTar</span> <span class="k">if</span> <span class="n">tar</span> <span class="k">else</span> <span class="n">MungeToDirectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">munge</span> <span class="o">=</span> <span class="n">munge_cls</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">text_relational_min</span><span class="o">=</span><span class="n">text_relational_min</span><span class="p">,</span>
            <span class="n">force_relational</span><span class="o">=</span><span class="n">force_relational</span><span class="p">,</span>
            <span class="n">dirname_fmt</span><span class="o">=</span><span class="n">dirname_fmt</span><span class="p">,</span>
            <span class="n">nonscalar_file_type</span><span class="o">=</span><span class="n">nonscalar_file_type</span><span class="p">,</span>
            <span class="n">metadata_dirname</span><span class="o">=</span><span class="n">metadata_dirname</span><span class="p">,</span>
            <span class="c1"># **metadata</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_input</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append</span> <span class="o">=</span> <span class="n">append</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_row_preprocessor</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__owner_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__owner_init__</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>

        <span class="n">devices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_rack</span><span class="o">.</span><span class="n">recursive_devices</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">({</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&lt;unset path&gt;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="p">[],</span> <span class="n">never</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;isopen&quot;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure the data to aggregate from value, property, or datareturn traits in the given devices.</span>

<span class="sd">        Device may be a single device instance, or an</span>
<span class="sd">        several devices in an iterable (such as a list</span>
<span class="sd">        or tuple) to apply to each one.</span>

<span class="sd">        Subsequent calls to :func:`observe_states` replace</span>
<span class="sd">        the existing list of observed property traits for each</span>
<span class="sd">        device.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            devices: Device instance or iterable of Device instances</span>
<span class="sd">            changes (bool): Whether to automatically log each time a property trait is set for the supplied device(s)</span>

<span class="sd">            always: name (or iterable of multiple names) of property traits to actively update on each call to get()</span>
<span class="sd">            never: name (or iterable of multiple names) of property traits to exclude from aggregated result (overrides :param:`always`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span>
            <span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="n">changes</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="n">always</span><span class="p">,</span> <span class="n">never</span><span class="o">=</span><span class="n">never</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_row_preprocessor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define a function that is called to modify each pending data row</span>
<span class="sd">        before it is committed to disk. It should accept a single argument,</span>
<span class="sd">        a function or other callable that accepts a single argument (the</span>
<span class="sd">        row dictionary) and returns the dictionary modified for write</span>
<span class="sd">        to disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_row_preprocessor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_row_preprocessor</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;func argument must be callable or None&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new row of data to the list of rows that await writes</span>
<span class="sd">        to disk, `self.pending_output`. This cache of pending data row is in</span>
<span class="sd">        the dictionary `self.pending_output`.</span>

<span class="sd">        The data row is represented as a dict in the form {&#39;column_name&#39;: value}.</span>
<span class="sd">        This dict is formed here with</span>
<span class="sd">        * the most recent value, property, and datareturn traits ({trait_name: latest_value} as configured by `self.observe`);</span>
<span class="sd">        * optional positional dict args[0] (each {key: value});</span>
<span class="sd">        * optional keyword arguments in `kwargs` (each {key: value})</span>

<span class="sd">        Keyword arguments are passed in as ::</span>

<span class="sd">        &gt;&gt;&gt;    db.new_row(dict(name0=value0), name1=value1, name2=value2, nameN=valueN)</span>

<span class="sd">        Simple &quot;scalar&quot; database types like numbers, booleans, and strings</span>
<span class="sd">        are added directly to the table. Non-scalar or multidimensional values are stored</span>
<span class="sd">        in a separate file (as defined in :func:`set_path_format`), and the path</span>
<span class="sd">        to this file is stored in the table.</span>

<span class="sd">        In order to write `self.pending_output` to disk, use :func:`self.write`.</span>

<span class="sd">        :param bool copy=True: When `True` (the default), use a deep copy of `data` to avoid</span>
<span class="sd">        problems with overwriting references to data if `data` is reused during test. This takes some extra time; set to `False` to skip this copy operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the dictionary representation of the row added to `self.pending_output`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">do_copy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Start with input arguments</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#            if not isinstance(args[0], dict):</span>
            <span class="c1">#                raise TypeError(&#39;argument to append must be a dictionary&#39;)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="n">do_copy</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Pull in observed states</span>
        <span class="n">aggregated_output</span><span class="p">,</span> <span class="n">aggregated_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_copy</span><span class="p">:</span>
            <span class="n">aggregated_output</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">aggregated_output</span><span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">aggregated_output</span><span class="p">)</span>

        <span class="c1"># Pull in keyword arguments</span>
        <span class="k">if</span> <span class="n">do_copy</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new data row has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="si">}</span><span class="s2"> columns&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aggregated_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Commit any pending rows to the root database, converting</span>
<span class="sd">        non-scalar data to data files, and replacing their dictionary value</span>
<span class="sd">        with the relative path to the data file.</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_input</span><span class="p">):</span>
            <span class="n">util</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;the input and output have mismatched length&quot;</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_input</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_preprocessor</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">proc</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pending_input</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">proc</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_input</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_root</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@contextmanager</span>
    <span class="nd">@util</span><span class="o">.</span><span class="n">hide_in_traceback</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;calls `self.new_row(*args, **kws); self.write()` on context exit.</span>

<span class="sd">        This is meant as a convenience for defining execution behavior in</span>
<span class="sd">        table inputs for Racks.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_row</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_write_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write pending data. This must be implemented by inheriting classes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove any queued data that has been added by append.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_input</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_relational_file_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the format to use for relational data files.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            format (str): one of &#39;csv&#39;, &#39;json&#39;, &#39;feather&#39;, or &#39;pickle&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;set_nonscalar_file_type is deprecated; set when creating</span>
<span class="sd">                         the database object instead with the nonscalar_output flag&quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;feather&quot;</span><span class="p">,</span> <span class="s2">&quot;pickle&quot;</span><span class="p">,</span> <span class="s2">&quot;db&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;relational file data format </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2"> not supported&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="o">.</span><span class="n">nonscalar_file_type</span> <span class="o">=</span> <span class="nb">format</span>

    <span class="k">def</span> <span class="nf">set_path_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the path name convention for relational files that is used when</span>
<span class="sd">            a table entry contains non-scalar (multidimensional) information and will</span>
<span class="sd">            need to be stored in a separate file. The entry in the aggregate property traits table</span>
<span class="sd">            becomes the path to the file.</span>

<span class="sd">            The format string follows the syntax of python&#39;s python&#39;s built-in :func:`str.format`.\</span>
<span class="sd">            You may use any keys from the table to form the path. For example, consider a\</span>
<span class="sd">            scenario where aggregate device property traits includes `inst1_frequency` of `915e6`,\</span>
<span class="sd">            and :func:`append` has been called as `append(dut=&quot;DUT15&quot;)`. If the current\</span>
<span class="sd">            aggregate property trait entry includes inst1_frequency=915e6, then the format string\</span>
<span class="sd">            &#39;{dut}/{inst1_frequency}&#39; means relative data path &#39;DUT15/915e6&#39;.</span>

<span class="sd">            Arguments:</span>
<span class="sd">                format: a string compatible with :func:`str.format`, with replacement\</span>
<span class="sd">            fields defined from the keys from the current entry of results and aggregated states.\</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;set_path_format is deprecated; set when creating</span>
<span class="sd">                         the database object instead with the nonscalar_output flag&quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="o">.</span><span class="n">dirname_fmt</span> <span class="o">=</span> <span class="nb">format</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the file or database connection.</span>
<span class="sd">        This is an abstract base method (to be overridden by inheriting classes)</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;cannot open dB while path is None&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">,</span> <span class="n">never</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="o">.</span><span class="n">_traits</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">])</span>

        <span class="c1"># Do some checks on the relative data directory before we consider overwriting</span>
        <span class="c1"># the root db.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> is open&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
        <span class="c1"># try:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="o">.</span><span class="n">save_metadata</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span><span class="o">.</span><span class="n">name_map</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># except BaseException as e:</span>
        <span class="c1">#     traceback.print_exc()</span>


<span class="k">class</span> <span class="nc">CSVLogger</span><span class="p">(</span><span class="n">RelationalTableLogger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store data, value traits, and property traits to disk into a root database formatted as a comma-separated value (CSV) file.</span>

<span class="sd">    This extends :class:`Aggregator` to support</span>

<span class="sd">    #. queuing aggregate property trait of devices by lists of dictionaries;</span>
<span class="sd">    #. custom metadata in each queued aggregate property trait entry; and</span>
<span class="sd">    #. custom response to non-scalar data (such as relational databasing).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        path (str): Base path to use for the root database</span>
<span class="sd">        overwrite (bool): Whether to overwrite the root database if it exists (otherwise, append)</span>
<span class="sd">        text_relational_min: Text with at least this many characters is stored as a relational text file instead of directly in the database</span>
<span class="sd">        force_relational: A list of columns that should always be stored as relational data instead of directly in the database</span>
<span class="sd">        nonscalar_file_type: The data type to use in non-scalar (tabular, vector, etc.) relational data</span>
<span class="sd">        metadata_dirname: The name of the subdirectory that should be used to store metadata (device connection parameters, etc.)</span>
<span class="sd">        tar: Whether to store the relational data within directories in a tar file, instead of subdirectories</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ROOT_FILE_NAME</span> <span class="o">=</span> <span class="n">OUTPUT_FILE_NAME</span> <span class="o">=</span> <span class="s2">&quot;outputs.csv&quot;</span>
    <span class="n">INPUT_FILE_NAME</span> <span class="o">=</span> <span class="s2">&quot;inputs.csv&quot;</span>
    <span class="n">output_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">nonscalar_file_type</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>

<div class="viewcode-block" id="CSVLogger.open"><a class="viewcode-back" href="../../labbench.html#labbench.CSVLogger.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instead of calling `open` directly, consider using</span>
<span class="sd">        `with` statements to guarantee proper disconnection</span>
<span class="sd">        if there is an error. For example, the following</span>
<span class="sd">        sets up a connected instance::</span>

<span class="sd">            with CSVLogger(&#39;my.csv&#39;) as db:</span>
<span class="sd">                ### do the data acquisition here</span>
<span class="sd">                pass</span>

<span class="sd">        would instantiate a `CSVLogger` instance, and also guarantee</span>
<span class="sd">        a final attempt to write unwritten data is written, and that</span>
<span class="sd">        the file is closed when exiting the `with` block, even if there</span>
<span class="sd">        is an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_append</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_FILE_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">INPUT_FILE_NAME</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="n">file_name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># test access by starting the root table</span>
                <span class="n">file_path</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_append</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;root table already exists at &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;, while append=False&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append</span> <span class="ow">and</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># there&#39;s something here and we plan to append</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_label</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">file_name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_root</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_write_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write queued rows of data to csv. This is called automatically on :func:`close`, or when</span>
<span class="sd">        exiting a `with` block.</span>

<span class="sd">        If the class was created with overwrite=True, then the first call to _write_root() will overwrite</span>
<span class="sd">        the preexisting file; subsequent calls append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">def</span> <span class="nf">append_csv</span><span class="p">(</span><span class="n">path_to_csv</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">isfirst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path_to_csv</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">pending</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">pending</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_label</span>
            <span class="n">pending</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pending</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span>

            <span class="k">if</span> <span class="n">isfirst</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">path_to_csv</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pending</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">path_to_csv</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">path_to_csv</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="p">:]</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">path_to_csv</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">path_to_csv</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_csv</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">path_to_csv</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">isfirst</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">append_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_FILE_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span><span class="p">)</span>
        <span class="n">append_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">INPUT_FILE_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_input</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MungeToHDF</span><span class="p">(</span><span class="n">Device</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is where ugly but necessary sausage making organizes</span>
<span class="sd">    in a file output with a key in the root database.</span>

<span class="sd">    The following conversions to relational files are attempted in order to</span>
<span class="sd">    convert each value in the row dictionary:</span>

<span class="sd">    1. Text containing a valid file or directory *outside* of the root data</span>
<span class="sd">       directory is made relational by moving the file or directory into</span>
<span class="sd">       the current row. The text is replaced with the updated relative path;</span>
<span class="sd">    2. Text longer than `text_relational_min` is dumped into a relational</span>
<span class="sd">       text file;</span>
<span class="sd">    3. 1- or 2-D data is converted to a pandas Series or DataFrame, and</span>
<span class="sd">       dumped into a relational file defined by the extension set by</span>
<span class="sd">       `nonscalar_file_type`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">resource</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;hdf file location&quot;</span><span class="p">)</span>
    <span class="n">key_fmt</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">str</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{id}</span><span class="s2"> </span><span class="si">{host_time}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;format for linked data in the root database (keyed on column)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">h5py</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Break special cases of row items that need to be stored in</span>
<span class="sd">        relational files. The row valueis replaced in-place with the relative</span>
<span class="sd">        path to the data saved on disk.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            row: dictionary of {&#39;entry_name&#39;: &quot;entry_value&quot;} pairs</span>
<span class="sd">        Returns:</span>
<span class="sd">            the row dictionary, replacing special entries with the relative path to the saved data file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">is_path</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># A path outside the relational database tree</span>
            <span class="k">if</span> <span class="n">is_path</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="c1"># A file or directory that should be moved in</span>
                <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_external_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="c1"># A long string that should be written to a text file</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">Number</span><span class="p">)):</span>
                <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="c1"># vector, table, matrix, etc.</span>
                <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_nonscalar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">rf</span><span class="s2">&quot;unrecognized type for row entry &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; with type </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">save_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key_func</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">def</span> <span class="nf">process_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">key_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_from_nonscalar</span><span class="p">(</span><span class="n">key_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">owner</span><span class="p">,</span> <span class="n">owner_name</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">owner_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_values&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">owner</span><span class="p">:</span>
                    <span class="n">summary</span><span class="p">[</span><span class="n">key_func</span><span class="p">(</span><span class="n">owner_name</span><span class="p">,</span> <span class="n">trait</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">owner</span><span class="p">,</span> <span class="n">trait</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">process_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">summary</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_nonscalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write nonscalar (potentially array-like, or a python object) data</span>
<span class="sd">        to a file, and return a path to the file</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: name of the entry to write, used as the filename</span>
<span class="sd">            value: the object containing array-like data</span>
<span class="sd">            row: row dictionary, or None (the default) to write to the metadata folder</span>
<span class="sd">        Returns:</span>
<span class="sd">            the path to the file, relative to the directory that contains the root database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">df</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="c1"># We couldn&#39;t make a DataFrame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to form DataFrame from </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">; pickling object instead&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">_from_external_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntries</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;/metadata </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">name</span>


<span class="k">class</span> <span class="nc">HDFLogger</span><span class="p">(</span><span class="n">RelationalTableLogger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store data and activity from value and property sets and gets to disk</span>
<span class="sd">    into a root database formatted as an HDF file.</span>

<span class="sd">    This extends :class:`Aggregator` to support</span>

<span class="sd">    #. queuing aggregate property trait of devices by lists of dictionaries;</span>
<span class="sd">    #. custom metadata in each queued aggregate property trait entry; and</span>
<span class="sd">    #. custom response to non-scalar data (such as relational databasing).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        path (str): Base path to use for the root database</span>
<span class="sd">        append (bool): Whether to append to the root database if it already exists (otherwise, raise IOError)</span>
<span class="sd">        key_fmt (str): format to use for keys in the h5</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">KEY_OUTPUT</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
    <span class="n">KEY_INPUT</span> <span class="o">=</span> <span class="s2">&quot;input&quot;</span>

    <span class="n">nonscalar_file_type</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">key_fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{id}</span><span class="s2"> </span><span class="si">{host_time}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">git_commit_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># **metadata</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">append</span><span class="o">=</span><span class="n">append</span><span class="p">,</span>
            <span class="n">git_commit_in</span><span class="o">=</span><span class="n">git_commit_in</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Switch to the HDF munger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">munge</span> <span class="o">=</span> <span class="n">MungeToHDF</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key_fmt</span><span class="o">=</span><span class="n">key_fmt</span><span class="p">)</span>

<div class="viewcode-block" id="HDFLogger.open"><a class="viewcode-back" href="../../labbench.html#labbench.HDFLogger.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instead of calling `open` directly, consider using</span>
<span class="sd">        `with` statements to guarantee proper disconnection</span>
<span class="sd">        if there is an error. For example, the following</span>
<span class="sd">        sets up a connected instance::</span>

<span class="sd">            with HDFLogger(&#39;my.csv&#39;) as db:</span>
<span class="sd">                ### do the data acquisition here</span>
<span class="sd">                pass</span>

<span class="sd">        would instantiate a `CSVLogger` instance, and also guarantee</span>
<span class="sd">        a final attempt to write unwritten data is written, and that</span>
<span class="sd">        the file is closed when exiting the `with` block, even if there</span>
<span class="sd">        is an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_root</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_write_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write queued rows of data to csv. This is called automatically on :func:`close`, or when</span>
<span class="sd">        exiting a `with` block.</span>

<span class="sd">        If the class was created with overwrite=True, then the first call to _write_root() will overwrite</span>
<span class="sd">        the preexisting file; subsequent calls append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">def</span> <span class="nf">write_table</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;write table! &quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">isfirst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">pending</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">pending</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_label</span>
            <span class="n">pending</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span>
            <span class="k">if</span> <span class="n">isfirst</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;first!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pending</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pending</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_append</span><span class="p">)</span>

        <span class="n">write_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_OUTPUT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span><span class="p">)</span>
        <span class="n">write_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_INPUT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_input</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SQLiteLogger</span><span class="p">(</span><span class="n">RelationalTableLogger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store data and property traits to disk into an an sqlite database.</span>

<span class="sd">    This extends :class:`Aggregator` to support</span>

<span class="sd">    #. queuing aggregate property trait of devices by lists of dictionaries;</span>
<span class="sd">    #. custom metadata in each queued aggregate property trait entry; and</span>
<span class="sd">    #. custom response to non-scalar data (such as relational databasing).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        path (str): Base path to use for the root database</span>
<span class="sd">        overwrite (bool): Whether to overwrite the root database if it exists (otherwise, append)</span>
<span class="sd">        text_relational_min: Text with at least this many characters is stored as a relational text file instead of directly in the database</span>
<span class="sd">        force_relational: A list of columns that should always be stored as relational data instead of directly in the database</span>
<span class="sd">        nonscalar_file_type: The data type to use in non-scalar (tabular, vector, etc.) relational data</span>
<span class="sd">        metadata_dirname: The name of the subdirectory that should be used to store metadata (device connection parameters, etc.)</span>
<span class="sd">        tar: Whether to store the relational data within directories in a tar file, instead of subdirectories</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">index_label</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>  <span class="c1"># Don&#39;t change this or sqlite breaks :(</span>
    <span class="n">ROOT_FILE_NAME</span> <span class="o">=</span> <span class="s2">&quot;root.db&quot;</span>
    <span class="n">OUTPUT_TABLE_NAME</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
    <span class="n">_columns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inprogress</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">committed</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">output_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="SQLiteLogger.open"><a class="viewcode-back" href="../../labbench.html#labbench.SQLiteLogger.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instead of calling `open` directly, consider using</span>
<span class="sd">        `with` statements to guarantee proper disconnection</span>
<span class="sd">        if there is an error. For example, the following</span>
<span class="sd">        sets up a connected instance::</span>

<span class="sd">            with SQLiteLogger(&#39;my.db&#39;) as db:</span>
<span class="sd">                ### do the data acquisition here</span>
<span class="sd">                pass</span>

<span class="sd">        would instantiate a `SQLiteLogger` instance, and also guarantee</span>
<span class="sd">        a final attempt to write unwritten data is written, and that</span>
<span class="sd">        the file is closed when exiting the `with` block, even if there</span>
<span class="sd">        is an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>  <span class="c1"># database connection</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">root</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;the root data directory path &#39;</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">&#39; already exists, and is not a directory.&quot;</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># test writes</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">if</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>

        <span class="c1">#        if not self.path.lower().endswith(&#39;.db&#39;):</span>
        <span class="c1">#            self.path += &#39;.db&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROOT_FILE_NAME</span><span class="p">)</span>

        <span class="c1"># Create an engine via sqlalchemy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite:///</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append</span><span class="p">:</span>
                <span class="c1"># read the last row to 1) list the columns and 2) get index</span>
                <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select * from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_TABLE_NAME</span><span class="si">}</span><span class="s2"> order by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_label</span><span class="si">}</span><span class="s2"> desc limit 1&quot;</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index_label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;root table already exists at &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;, but append=False&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inprogress</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_root</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_write_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write queued rows of data to the database. This also is called automatically on :func:`close`, or when</span>
<span class="sd">        exiting a `with` block.</span>

<span class="sd">        If the class was created with overwrite=True, then the first call to _write_root() will overwrite</span>
<span class="sd">        the preexisting file; subsequent calls append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Put together a DataFrame from self.pending that is guaranteed</span>
        <span class="c1"># to include the columns defined in self._columns</span>
        <span class="n">traits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_output</span><span class="p">)</span>
        <span class="n">traits</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span>
        <span class="n">blank</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span>

        <span class="c1"># Check for new columns, and insert into the database</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trait_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">blank_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">blank</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">new_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">trait_cols</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">blank_cols</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">new_columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inserting new column &#39;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">column_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_type_name</span><span class="p">(</span><span class="n">traits</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;alter table </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_TABLE_NAME</span><span class="si">}</span><span class="s2"> add column </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">column_type</span><span class="si">}</span><span class="s2"> default NULL&quot;</span>
                <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Form the new database row</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">blank</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">traits</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>

        <span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">ArgumentError</span>

        <span class="c1"># Append to db</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_TABLE_NAME</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span>
                <span class="n">if_exists</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">index_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index_label</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ArgumentError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to convert index label </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ArgumentError</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">+=</span> <span class="mi">1</span>

<div class="viewcode-block" id="SQLiteLogger.key"><a class="viewcode-back" href="../../labbench.html#labbench.SQLiteLogger.key">[docs]</a>    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The key determines the SQL column name. df.to_sql does not seem</span>
<span class="sd">        to support column names that include spaces</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span></div>

    <span class="k">def</span> <span class="nf">_sql_type_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pandas.io.sql</span> <span class="kn">import</span> <span class="n">_SQL_TYPES</span>

        <span class="n">col_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_notnull_col_dtype</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_type</span> <span class="o">==</span> <span class="s2">&quot;timedelta64&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;the &#39;timedelta&#39; type is not supported, and will be </span><span class="se">\</span>
<span class="s2">                           written as integer values (ns frequency) to the</span><span class="se">\</span>
<span class="s2">                           database.&quot;</span>
            <span class="p">)</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>

        <span class="k">elif</span> <span class="n">col_type</span> <span class="o">==</span> <span class="s2">&quot;datetime64&quot;</span><span class="p">:</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;datetime&quot;</span>

        <span class="k">elif</span> <span class="n">col_type</span> <span class="o">==</span> <span class="s2">&quot;empty&quot;</span><span class="p">:</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>

        <span class="k">elif</span> <span class="n">col_type</span> <span class="o">==</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Complex datatypes not supported&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">col_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_SQL_TYPES</span><span class="p">:</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>

        <span class="k">return</span> <span class="n">_SQL_TYPES</span><span class="p">[</span><span class="n">col_type</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_notnull_col_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer datatype of the Series col.  In case the dtype of col is &#39;object&#39;</span>
<span class="sd">        and it contains NA values, this infers the datatype of the not-NA</span>
<span class="sd">        values.  Needed for inserting typed data containing NULLs, GH8778.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="n">col_for_inference</span> <span class="o">=</span> <span class="n">col</span>
        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
            <span class="n">notnulldata</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">notnulldata</span><span class="p">):</span>
                <span class="n">col_for_inference</span> <span class="o">=</span> <span class="n">notnulldata</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">infer_dtype</span><span class="p">(</span><span class="n">col_for_inference</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">to_feather</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a dataframe to a feather file on disk. Any index will be moved</span>
<span class="sd">    to a column, index and column name metadata will be removed,</span>
<span class="sd">    and columns names will be changed to a string.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        data: dataframe to write to disk</span>
<span class="sd">        path: path to file to write</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">iname</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">cname</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic</span>
            <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">str</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">iname</span>
        <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">cname</span>


<span class="k">def</span> <span class="nf">read_sqlite</span><span class="p">(</span>
    <span class="n">path</span><span class="p">,</span>
    <span class="n">table_name</span><span class="o">=</span><span class="n">SQLiteLogger</span><span class="o">.</span><span class="n">OUTPUT_TABLE_NAME</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">index_col</span><span class="o">=</span><span class="n">RelationalTableLogger</span><span class="o">.</span><span class="n">index_label</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper to that uses pandas.read_sql_table to load a table from an sqlite database at the specified path.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        path: sqlite database path</span>
<span class="sd">        table_name: name of table in the sqlite database</span>
<span class="sd">        columns: columns to query and return, or None (default) to return all columns</span>
<span class="sd">        nrows: number of rows of data to read, or None (default) to return all rows</span>
<span class="sd">        index_col: the name of the column to use as the index</span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame instance containing data loaded from `path`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sqlite:///</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">nrows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">nrows</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read tabular data from a file in one of various formats</span>
<span class="sd">    using pandas.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        path (str): path to the  data file.</span>
<span class="sd">        columns: a column or iterable of multiple columns to return from the data file, or None (the default) to return all columns</span>
<span class="sd">        nrows: number of rows to read at the beginning of the table, or None (the default) to read all rows</span>
<span class="sd">        format (str): data file format, one of [&#39;pickle&#39;,&#39;feather&#39;,&#39;csv&#39;,&#39;json&#39;,&#39;csv&#39;], or &#39;auto&#39; (the default) to guess from the file extension</span>
<span class="sd">        kws: additional keyword arguments to pass to the pandas read_&lt;ext&gt; function matching the file extension</span>
<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame instance containing data read from file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">from</span> <span class="nn">pyarrow.feather</span> <span class="kn">import</span> <span class="n">read_feather</span>

    <span class="n">reader_guess</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">,</span>
        <span class="s2">&quot;pickle&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">,</span>
        <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="n">read_sqlite</span><span class="p">,</span>
        <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span> <span class="n">read_sqlite</span><span class="p">,</span>
        <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">,</span>
        <span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">reader_guess</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="n">read_feather</span><span class="p">,</span> <span class="s2">&quot;feather&quot;</span><span class="p">:</span> <span class="n">read_feather</span><span class="p">})</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;feather format is not available in this pandas installation, and will not be supported in labbench&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
        <span class="n">path_or_buf</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;file is empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;can only guess format for string path - specify extension&quot;</span>
            <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">reader_guess</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;couldn&#39;t guess a reader from extension of file </span><span class="si">{</span><span class="n">path_or_buf</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">if</span> <span class="n">reader</span> <span class="o">==</span> <span class="n">read_sqlite</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reader</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">reader</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reader</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reader</span><span class="p">(</span><span class="n">path_or_buf</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">nrows</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">MungeTarReader</span><span class="p">:</span>
    <span class="n">tarnames</span> <span class="o">=</span> <span class="s2">&quot;data.tar&quot;</span><span class="p">,</span> <span class="s2">&quot;data.tar.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;data.tar.bz2&quot;</span><span class="p">,</span> <span class="s2">&quot;data.tar.lz4&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">tarname</span><span class="o">=</span><span class="s2">&quot;data.tar&quot;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tarfile</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tarname</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tarfile</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ex</span>


<span class="k">class</span> <span class="nc">MungeDirectoryReader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MungeReader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Guess the type of munging performed on the relational data, and return</span>
<span class="sd">    a reader suited to loading that file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; TODO: Make this smarter, perhaps by trying to read an entry from</span>
<span class="sd">        the root database</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">MungeTarReader</span><span class="o">.</span><span class="n">tarnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">n</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">MungeTarReader</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">tarname</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MungeDirectoryReader</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_relational</span><span class="p">(</span>
    <span class="n">path</span><span class="p">,</span>
    <span class="n">expand_col</span><span class="p">,</span>
    <span class="n">root_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">root_nrows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">root_format</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">prepend_column_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flatten a relational database table by loading the table located each row of</span>
<span class="sd">    `root[expand_col]`. The value of each column in this row</span>
<span class="sd">    is copied to the loaded table. The columns in the resulting table generated</span>
<span class="sd">    on each row are downselected</span>
<span class="sd">    according to `root_cols` and `target_cols`. Each of the resulting tables</span>
<span class="sd">    is concatenated and returned.</span>

<span class="sd">    The expanded dataframe may be very large, making downselecting a practical</span>
<span class="sd">    necessity in some scenarios.</span>

<span class="sd">    TODO: Support for a list of expand_col?</span>

<span class="sd">    :param pandas.DataFrame root: the root database, consisting of columns containing data and columns containing paths to data files</span>
<span class="sd">        expand_col (str): the column in the root database containing paths to    data files that should be expanded</span>
<span class="sd">        root_cols: a column (or array-like iterable of multiple columns) listing the root columns to include in the expanded dataframe, or None (the default) pass all columns from `root`</span>
<span class="sd">        target_cols: a column (or array-like iterable of multiple columns) listing the root columns to include in the expanded dataframe, or None (the default) to pass all columns loaded from each root[expand_col]</span>
<span class="sd">        root_path: a string containing the full path to the root database (to help find the relational files)</span>
<span class="sd">        prepend_column_name (bool): whether to prepend the name of the expanded column from the root database</span>
<span class="sd">    Returns:</span>
<span class="sd">        the expanded dataframe</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

    <span class="c1"># if not isinstance(root, (pd.DataFrame,pd.Series)):</span>
    <span class="c1">#     raise ValueError(&#39;expected root to be a DataFrame instance, but it is {} instead&#39;\</span>
    <span class="c1">#                      .format(repr(type(root))))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expand_col</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;expand_col must a str, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">expand_col</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">root_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">root_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root_cols</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">expand_col</span><span class="p">]</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">root_cols</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">root_nrows</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">root_format</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">MungeReader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">expand_col</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">expand_col</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">sub</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">expand_col</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">target_cols</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">prepend_column_name</span><span class="p">:</span>
                <span class="n">prepend</span> <span class="o">=</span> <span class="n">expand_col</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prepend</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># Rename columns</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">prepend</span> <span class="o">+</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">sub</span><span class="p">[</span><span class="n">prepend</span> <span class="o">+</span> <span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># # Downselect root columns</span>
            <span class="c1"># if root_cols is not None:</span>
            <span class="c1">#     row = row[root_cols]</span>

            <span class="c1"># Add in columns from the root</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">sub</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">yield</span> <span class="n">sub</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">generate</span><span class="p">(),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../labbench.html">labbench vgit</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">labbench._data</a></li> 
      </ul>
    </div>
<hr \>
<section class="footer">
<br><a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#privpolicy">Privacy Policy</a> | <a target="_blank" href="http://www.nist.gov/public_affairs/privacy.cfm#secnot">Security Notice</a> | <a href="http://www.nist.gov/public_affairs/privacy.cfm#accesstate">Accessibility Statement</a>
<br><em>United States government work, not subject to copyright in the United States</em>
</section>

  </body>
</html>